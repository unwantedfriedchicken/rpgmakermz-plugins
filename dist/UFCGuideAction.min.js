var Imported=Imported||{};Imported.UFCGuideAction=!0;var UFC=UFC||{};function GuideAction(){this.initialize(...arguments)}UFC.UFCGA=UFC.UFCGA||{},UFC.UFCGA.VERSION=1.2,UFC.UFCGA.ALIAS=UFC.UFCGA.ALIAS||{},UFC.UFCGA.PARAMETERS=PluginManager.parameters("UFCGuideAction"),UFC.UFCGA.CONFIG={blockColor:PIXI.utils.string2hex(UFC.UFCGA.PARAMETERS.blockColor),blockColorAlpha:+UFC.UFCGA.PARAMETERS.blockColorAlpha,openColor:PIXI.utils.string2hex(UFC.UFCGA.PARAMETERS.openColor),openColorAlpha:+UFC.UFCGA.PARAMETERS.openColorAlpha},GuideAction.prototype.initialize=function(){this._mouseMode=!1,this._tmpMouseData={x:TouchInput.x,y:TouchInput.y},this._mouseTrigger={trigger:!1,x:0,y:0},this._mouseMoveThreshold=10,this._show=!0,this._graphics=null,this._tileWidth=$gameMap.tileWidth(),this._tileHeight=$gameMap.tileHeight(),this._active=!1,this._perciseMode=!0,this._blocked=!1,this._color={color:UFC.UFCGA.CONFIG.openColor,alpha:UFC.UFCGA.CONFIG.openColorAlpha},this._x=0,this._y=0,this._d=2,this._type="default",this._onlyTerrain={},this._exceptTerrain={},this._onlyRegion={},this._exceptRegion={},this.createSharp(),this.setDirection(2),this.setVisible(!1),this._event=new PIXI.utils.EventEmitter},Object.defineProperty(GuideAction.prototype,"isMouseMode",{get:function(){return this._mouseMode}}),Object.defineProperty(GuideAction.prototype,"getOnlyTerrain",{get:function(){return void 0===this._onlyTerrain[this._type]&&(this._onlyTerrain[this._type]=[]),this._onlyTerrain[this._type]}}),Object.defineProperty(GuideAction.prototype,"getExceptTerrain",{get:function(){return void 0===this._exceptTerrain[this._type]&&(this._exceptTerrain[this._type]=[]),this._exceptTerrain[this._type]}}),Object.defineProperty(GuideAction.prototype,"getExceptRegion",{get:function(){return void 0===this._exceptRegion[this._type]&&(this._exceptRegion[this._type]=[]),this._exceptRegion[this._type]}}),Object.defineProperty(GuideAction.prototype,"getOnlyRegion",{get:function(){return void 0===this._onlyRegion[this._type]&&(this._onlyRegion[this._type]=[]),this._onlyRegion[this._type]}}),GuideAction.prototype.setType=function(t){return this._type=t,this},GuideAction.prototype.setMouseMode=function(t){this._mouseMode=t,this.resetParent()},GuideAction.prototype.resetParent=function(){const t=SceneManager.getSpriteSetMap();if(this.isMouseMode)this._graphics.setParent(t._tilemap);else{for(const e of t._characterSprites)if(e._character==$gamePlayer){this._graphics.setParent(e);break}this.clearMouseEvent()}},GuideAction.prototype.setOnlyTerrain=function(t){this.getOnlyTerrain.push(...t)},GuideAction.prototype.setExceptTerrain=function(t){this.getExceptTerrain.push(...t)},GuideAction.prototype.setOnlyRegion=function(t){this.getOnlyRegion.push(...t)},GuideAction.prototype.setExceptRegion=function(t){this.getExceptRegion.push(...t)},GuideAction.prototype.setActive=function(t){t||this.clearMouseEvent(),this._active=t,this.setVisible(t)},GuideAction.prototype.isTriggered=function(){return this._mouseTrigger.trigger},GuideAction.prototype.clearTrigger=function(){this._mouseTrigger.trigger=!1},GuideAction.prototype.clearMouseEvent=function(){this._mouseMode=!1,this._tmpMouseData={x:TouchInput.x,y:TouchInput.y},this._graphics.interactive=!0,this.clearTrigger()},GuideAction.prototype.isActive=function(){return this._active},GuideAction.prototype.isBlocked=function(){return this._blocked},GuideAction.prototype.setBlocked=function(t){t?(this._color.color=UFC.UFCGA.CONFIG.blockColor,this._color.alpha=UFC.UFCGA.CONFIG.blockColorAlpha):(this._color.color=UFC.UFCGA.CONFIG.openColor,this._color.alpha=UFC.UFCGA.CONFIG.openColorAlpha),this.createSharp(),this._blocked=t},GuideAction.prototype.createSharp=function(t="rectangle"){switch(!this._graphics||this._graphics._destroyed?this._graphics=new PIXI.Graphics:(this._graphics.clear(),this._graphics.removeAllListeners()),t){case"rectangle":this._graphics.beginFill(this._color.color,this._color.alpha),this._graphics.drawRect(0,0,this._tileWidth,this._tileHeight),this._graphics.endFill()}this._graphics.interactive=!0,this._graphics.on("pointermove",this.onPointerMove,this)},GuideAction.prototype.setDirection=function(t=this._d,e=this._x,i=this._y){if(this.isMouseMode)return;this._x=e,this._y=i,this._d=t,this._perciseMode||(this.canPass(e,i,t)?this.setVisible(!0):this.setVisible(!1));switch(t){case 2:this.setPosition(-this._tileWidth/2,6);break;case 4:this.setPosition(-this._tileWidth/2-this._tileWidth,6-this._tileHeight);break;case 6:this.setPosition(this._tileWidth/2,6-this._tileHeight);break;case 8:this.setPosition(-this._tileWidth/2,2*-this._tileHeight+6)}},GuideAction.prototype.setVisible=function(t){this.getGraphics().visible=t},GuideAction.prototype.isVisible=function(){return this.getGraphics().visible},GuideAction.prototype.setPosition=function(t,e){this.getGraphics().x=t,this.getGraphics().y=e},GuideAction.prototype.reset=function(){this.createSharp(),this.setDirection(),this.setActive(this.isActive())},GuideAction.prototype.canPass=function(t,e,i){const o=$gameMap.roundXWithDirection(t,i),s=$gameMap.roundYWithDirection(e,i);return!!$gameMap.isValid(o,s)&&(!!this.isMapPassable(t,e,i)&&(!this.checkTDTower(o,s)&&(!this.isCollidedWithCharacters(o,s)&&!this.checkGrid(o,s))))},GuideAction.prototype.canPassMouse=function(t,e){return!!$gameMap.isValid(t,e)&&(!!$gameMap.checkPassage(t,e,15)&&(!this.checkTDTower(t,e)&&(!this.isCollidedWithCharacters(t,e)&&!this.checkGrid(t,e))))},GuideAction.prototype.checkTDTower=function(t,e){if(!Imported.UFCTowerDefense)return!1;return $gameMap.checkTDTower(t,e)},GuideAction.prototype.checkGrid=function(t,e){if(this.getOnlyTerrain.length<=0&&this.getExceptTerrain.length<=0&&this.getOnlyRegion.length<=0&&this.getExceptRegion.length<=0)return!1;let i=$gameMap.terrainTag(t,e),o=$gameMap.regionId(t,e);return this.getOnlyTerrain.length<=0&&this.getOnlyRegion.length<=0&&(this.getExceptTerrain.length>0||this.getExceptRegion.length>0)?!!(this.getExceptTerrain.includes(i)&&this.getExceptTerrain.length>=0)||!!(this.getExceptRegion.includes(o)&&this.getExceptRegion.length>=0):!!(this.getExceptTerrain.includes(i)&&this.getExceptTerrain.length>=0)||(!!(this.getExceptRegion.includes(o)&&this.getExceptRegion.length>=0)||!this.getOnlyTerrain.includes(i)&&!this.getOnlyRegion.includes(o))},GuideAction.prototype.update=function(){this.isActive()&&(this.isMouseMode&&(this._mouseTrigger.trigger?this.setPosition(this.screenX(this._mouseTrigger.x-.5),this.screenY(this._mouseTrigger.y-.5)):(this._x=$gameMap.canvasToMapX(TouchInput.x),this._y=$gameMap.canvasToMapY(TouchInput.y),this.setPosition(this.screenX(this._x-.5),this.screenY(this._y-.5))),(TouchInput.isTriggered()||TouchInput.isLongPressed())&&(this._x=$gameMap.canvasToMapX(TouchInput.x),this._y=$gameMap.canvasToMapY(TouchInput.y),this._mouseTrigger.x==this._x&&this._mouseTrigger.y==this._y||(this._mouseTrigger.trigger=!0,this._mouseTrigger.x=this._x,this._mouseTrigger.y=this._y))),this._perciseMode&&this.updateBlocked(),this.updateChild())},GuideAction.prototype.updateChild=function(){let t=this.getGraphics().children;if(t.length>0)for(const e of t)e.update&&e.update()},GuideAction.prototype.onPointerMove=function(t){if(this.isMouseMode)return this._tmpMouseData.x=TouchInput.x,void(this._tmpMouseData.y=TouchInput.y);const e=Math.abs(TouchInput.x-this._tmpMouseData.x),i=Math.abs(TouchInput.y-this._tmpMouseData.y);(e>this._mouseMoveThreshold||i>this._mouseMoveThreshold)&&(this.setMouseMode(!0),this._graphics.interactive=!1)},GuideAction.prototype.updateBlocked=function(t=!1){this.isMouseMode&&!t?this.canPassMouse(this._x,this._y)?this.isBlocked()&&this.setBlocked(!1):this.isBlocked()||this.setBlocked(!0):(t&&this.getPosition(),this.canPass(this._x,this._y,this._d)?this.isBlocked()&&this.setBlocked(!1):this.isBlocked()||this.setBlocked(!0))},GuideAction.prototype.screenX=function(t){const e=$gameMap.tileWidth();return Math.floor($gameMap.adjustX(t)*e+e/2)},GuideAction.prototype.screenY=function(t){const e=$gameMap.tileHeight();return Math.floor($gameMap.adjustY(t)*e+e/2)},GuideAction.prototype.isMapPassable=function(t,e,i){const o=$gameMap.roundXWithDirection(t,i),s=$gameMap.roundYWithDirection(e,i),r=this.reverseDir(i);return $gameMap.isPassable(t,e,i)&&$gameMap.isPassable(o,s,r)},GuideAction.prototype.reverseDir=function(t){return 10-t},GuideAction.prototype.isDestroyed=function(){return this._graphics._destroyed},GuideAction.prototype.getGraphics=function(){return this.isDestroyed()&&this.reset(),this._graphics},GuideAction.prototype.isCollidedWithCharacters=function(t,e){return this.isCollidedWithEvents(t,e)||this.isCollidedWithVehicles(t,e)},GuideAction.prototype.isCollidedWithEvents=function(t,e){return $gameMap.eventsXyNt(t,e).some(t=>t.isNormalPriority())},GuideAction.prototype.isCollidedWithVehicles=function(t,e){return $gameMap.boat().posNt(t,e)||$gameMap.ship().posNt(t,e)},GuideAction.prototype.getPosition=function(){return this._x=$gamePlayer._x,this._y=$gamePlayer._y,this._d=$gamePlayer._direction,{x:$gameMap.roundXWithDirection(this._x,this._d),y:$gameMap.roundYWithDirection(this._y,this._d)}},UFC.UFCGA.ALIAS._Game_Player_update=Game_Player.prototype.update,Game_Player.prototype.update=function(){UFC.UFCGA.ALIAS._Game_Player_update.apply(this,arguments),this.getGuideAction().update()},UFC.UFCGA.ALIAS._Game_Player_initMembers=Game_Player.prototype.initMembers,Game_Player.prototype.initMembers=function(){UFC.UFCGA.ALIAS._Game_Player_initMembers.apply(this,arguments),this._guideAction=new GuideAction},UFC.UFCGA.ALIAS._Game_Player_clearTransferInfo=Game_Player.prototype.clearTransferInfo,Game_Player.prototype.clearTransferInfo=function(){UFC.UFCGA.ALIAS._Game_Player_clearTransferInfo.apply(this,arguments),this.getGuideAction().setDirection(this._direction,this._x,this._y)},UFC.UFCGA.ALIAS._Game_Player_setDirection=Game_Player.prototype.setDirection,Game_Player.prototype.setDirection=function(t){UFC.UFCGA.ALIAS._Game_Player_setDirection.apply(this,arguments),this.getGuideAction().setDirection(t,this._x,this._y)},UFC.UFCGA.ALIAS._Game_Player_moveStraight=Game_Player.prototype.moveStraight,Game_Player.prototype.moveStraight=function(t){UFC.UFCGA.ALIAS._Game_Player_moveStraight.apply(this,arguments),this.getGuideAction().setDirection(t,this._x,this._y)},Game_Player.prototype.getGuideActionGraphics=function(){return this.getGuideAction().getGraphics()},Game_Player.prototype.getGuideAction=function(){return this._guideAction},UFC.UFCGA.ALIAS._Spriteset_Map_createCharacters=Spriteset_Map.prototype.createCharacters,Spriteset_Map.prototype.createCharacters=function(){UFC.UFCGA.ALIAS._Spriteset_Map_createCharacters.call(this,arguments);for(let t of this._characterSprites)if(t._character==$gamePlayer){t.addChild(t._character.getGuideActionGraphics());break}};