var Imported=Imported||{};Imported.UFCTowerDefense=!0;var UFC=UFC||{};UFC.UFCTD=UFC.UFCTD||{},UFC.UFCTD.VERSION=1.2,UFC.UFCTD.ALIAS=UFC.UFCTD.ALIAS||{};var $dataTDEnemy=$dataTDEnemy||{},$dataTDSpawnLocation=$dataTDSpawnLocation||{},$dataTDTrigger=$dataTDTrigger||{};UFC.UFCTD.PARAMETERS=PluginManager.parameters("UFCTowerDefense"),UFC.UFCTD.CONFIG={limitAnimation:+UFC.UFCTD.PARAMETERS.setting_limitAnimation,healthVarId:+UFC.UFCTD.PARAMETERS.setting_towerHealthVarId,healthMaxVarId:+UFC.UFCTD.PARAMETERS.setting_towerMaxHealthVarId,gameOverSwitchId:+UFC.UFCTD.PARAMETERS.setting_gameoverSwitchId,crystalName:UFC.UFCTD.PARAMETERS.setting_crystalName,sound:JSON.parse(UFC.UFCTD.PARAMETERS.setting_soundSettings)},UFC.UFCTD.HUDGUI={SETTINGS:{itemSize:+UFC.UFCTD.PARAMETERS.gui_itemBackpackSlotSize,itemCol:+UFC.UFCTD.PARAMETERS.gui_itemBackpackSlotCol,itemWindowType:+UFC.UFCTD.PARAMETERS.gui_itemBackpackBackgroundType,itemNumSize:+UFC.UFCTD.PARAMETERS.gui_itemBackpackNumSize},MESSAGE:{isHoverHUDItem:!1,isHoverGUIShop:!1,isBusy:function(){return UFC.UFCTD.HUDGUI.MESSAGE.isHoverHUDItem||UFC.UFCTD.HUDGUI.MESSAGE.isHoverGUIShop}}},UFC.UFCTD.TOWERSETTINGS={animateTower:"true"==UFC.UFCTD.PARAMETERS.animateTower,attackRangeOpacity:+UFC.UFCTD.PARAMETERS.attackRangeOpacity,auraRangeOpacity:+UFC.UFCTD.PARAMETERS.auraRangeOpacity,attackRangeColor:PIXI.utils.string2hex(UFC.UFCTD.PARAMETERS.attackRangeColor),auraRangeColor:PIXI.utils.string2hex(UFC.UFCTD.PARAMETERS.auraRangeColor),gridColor:UFC.UFCTD.PARAMETERS.gridColor,gridColorOpacity:255*+UFC.UFCTD.PARAMETERS.gridColorOpacity,gridTrapColor:UFC.UFCTD.PARAMETERS.gridTrapColor,gridTrapColorOpacity:255*+UFC.UFCTD.PARAMETERS.gridTrapColorOpacity},UFC.UFCTD.TOOLTIPSETTINGS={enable:"true"==UFC.UFCTD.PARAMETERS.tooltip,yPosition:+UFC.UFCTD.PARAMETERS.tooltipYPosition,fontSize:+UFC.UFCTD.PARAMETERS.tooltipFontSize,backgroundType:+UFC.UFCTD.PARAMETERS.tooltipBackgroundType},UFC.UFCTD.SHOPGUISETTINGS={enable:"true"==UFC.UFCTD.PARAMETERS.shopgui,defaultItems:JSON.parse(UFC.UFCTD.PARAMETERS.shopguiDefaultItems).map(e=>[0,+e,0,0]),itemsEdit:[],multiplier:+UFC.UFCTD.PARAMETERS.shopguiMultiplier,roundPrice:+UFC.UFCTD.PARAMETERS.shopguiRoundPrice,iconWidth:+UFC.UFCTD.PARAMETERS.shopguiIconWidth,iconHeight:+UFC.UFCTD.PARAMETERS.shopguiIconHeight,iconXPosition:+UFC.UFCTD.PARAMETERS.shopguiIconXPosition,iconYPosition:+UFC.UFCTD.PARAMETERS.shopguiIconYPosition},UFC.UFCTD.DEBUGMODE={enable:"true"==UFC.UFCTD.PARAMETERS.debugMode,tickerSpeed:+UFC.UFCTD.PARAMETERS.tickerSpeed,limitAnimation:+UFC.UFCTD.PARAMETERS.limitAnimation},PluginManager.registerCommand("UFCTowerDefense","setupEnemy",function(e){e.characterName=$gameMap._events[this._eventId]._characterName,e.characterIndex=$gameMap._events[this._eventId]._characterIndex,TowerDefenseManager.addDBEnemy(e)}),PluginManager.registerCommand("UFCTowerDefense","setSpawn",function(e){$dataTDSpawnLocation[this._mapId]||($dataTDSpawnLocation[this._mapId]={}),e._x=$gameMap._events[this._eventId]._x,e._y=$gameMap._events[this._eventId]._y,$dataTDSpawnLocation[this._mapId][this._eventId]=new ufcTowerSpawnData(e)}),PluginManager.registerCommand("UFCTowerDefense","showGUIItemSlot",function(e){TowerDefenseManager.showGUIItemSlot(e)}),PluginManager.registerCommand("UFCTowerDefense","showGold",function(e){TowerDefenseManager.showHUDTDGold(e)}),PluginManager.registerCommand("UFCTowerDefense","updateHUD",function(){TowerDefenseManager.updateHUD()}),PluginManager.registerCommand("UFCTowerDefense","showHealthBar",function(e){TowerDefenseManager.showHUDTDHealth(e)}),PluginManager.registerCommand("UFCTowerDefense","config",function(e){TowerDefenseManager.config(e)}),PluginManager.registerCommand("UFCTowerDefense","disableTowerDefense",function(e){let t="true"==e.destroyTower,i="true"==e.destroyEnemy,a="true"==e.deleteTDItems;TowerDefenseManager.disableTowerDefense(t,i,a)}),PluginManager.registerCommand("UFCTowerDefense","startWave",function(e){$gameMap.addTowerDefenseNewWave(e)}),PluginManager.registerCommand("UFCTowerDefense","limitAnimation",function(e){TowerDefenseManager.setLimitAnimation(+e.limit)}),PluginManager.registerCommand("UFCTowerDefense","triggerMove",function(e){TowerDefenseManager.addDBTrigger(this._mapId,this._eventId,TowerDefenseManager.TRIGGERTYPE.DIRECTION,e.direction)}),PluginManager.registerCommand("UFCTowerDefense","triggerDestroy",function(e){TowerDefenseManager.addDBTrigger(this._mapId,this._eventId,TowerDefenseManager.TRIGGERTYPE.DESTROY,{attack:"true"==e.attack,attackEventId:e.attackEventId,animationId:e.animationId})}),PluginManager.registerCommand("UFCTowerDefense","triggerConfig",function(e){TowerDefenseManager.addDBTrigger(this._mapId,this._eventId,TowerDefenseManager.TRIGGERTYPE.CONFIG,{enemyType:e.enemyType,onlyEnemy:JSON.parse(e.onlyEnemy),exceptEnemy:JSON.parse(e.exceptEnemy)})}),PluginManager.registerCommand("UFCTowerDefense","triggerWait",function(e){TowerDefenseManager.addDBTrigger(this._mapId,this._eventId,TowerDefenseManager.TRIGGERTYPE.WAIT,{duration:+e.duration})}),PluginManager.registerCommand("UFCTowerDefense","shopGUIItemsEdit",function(e){UFC.UFCTD.SHOPGUISETTINGS.itemsEdit=JSON.parse(e.items).map(e=>[0,+e,0,0])}),PluginManager.registerCommand("UFCTowerDefense","shopGUIItemsReset",function(){UFC.UFCTD.SHOPGUISETTINGS.itemsEdit=[]});const Data_ufcGrid=function(){this.initialize(...arguments)};function Game_TDEnemy(){this.initialize(...arguments)}function Game_TDTower(){this.initialize(...arguments)}function Game_ufcProjectile(){this.initialize(...arguments)}Data_ufcGrid.prototype.initialize=function(e){this._listType=e,this._destroy=!1,this._event=new PIXI.utils.EventEmitter,this._type=null,this._gridData={},this._bitmap={};for(let e of this._listType)this._gridData[e]=[],this._bitmap[e]=new Bitmap($gameMap.width()*$gameMap.tileWidth(),$gameMap.height()*$gameMap.tileHeight());this._eventData=[],this._lineSize=4,this._updateEventFreq=60,this._updateEventTime=0},Data_ufcGrid.prototype.setType=function(e){return this._type=e,this},Data_ufcGrid.prototype.setVisible=function(e){this._event.emit("showGrid",e)},Data_ufcGrid.prototype.refreshBitmap=function(){let e=this.getType;for(let e of this._listType){this._bitmap[e]=new Bitmap($gameMap.width()*$gameMap.tileWidth(),$gameMap.height()*$gameMap.tileHeight()),this.setType(e);for(let e=0;e<$gameMap.width();e++)for(let t=0;t<$gameMap.height();t++)this.getGridData()[e][t]?this.fillGrid(e,t):this.clearGrid(e,t)}this.setType(e)},Data_ufcGrid.prototype.getGridData=function(e){return this._gridData[e||this.getType]},Data_ufcGrid.prototype.calcGrid=function(){for(let e of this._listType){this.setType(e),$gamePlayer.getGuideAction().setType(e);for(let e=0;e<$gameMap.width();e++)for(let t=0;t<$gameMap.height();t++)this.getGridData()[e]||(this.getGridData()[e]=[]),this.getGridData()[e][t]=!0,!$gameMap.checkPassage(e,t,15)||$gamePlayer.getGuideAction().checkGrid(e,t)?(this.getGridData()[e][t]=!1,this.clearGrid(e,t)):this.fillGrid(e,t)}for(const e of $gameMap.events()){if(!e.isThrough())for(const t of this._listType)this.setType(t).clearGrid(e.x,e.y);this._eventData.push({event:e,pos:{x:e.x,y:e.y}})}},Data_ufcGrid.prototype.updateEvents=function(){if(this._updateEventTime--,this._updateEventTime>0)return;this._updateEventTime=this._updateEventFreq;let e=this.getType;for(const e of this._eventData){let t=!1;for(const i of this._listType){let a=this.setType(i).getGridData()[e.pos.x][e.pos.y];e.event._erased?(a&&this.fillGrid(e.pos.x,e.pos.y),t=!0):e.event.pos(e.pos.x,e.pos.y)||(this.getGridData()[e.pos.x][e.pos.y]&&this.fillGrid(e.pos.x,e.pos.y),this.clearGrid(e.event.x,e.event.y),e.pos.x=e.event.x,e.pos.y=e.event.y)}t&&this._eventData.remove(e)}this.setType(e)},Data_ufcGrid.prototype.posX=function(e){return e*$gameMap.tileWidth()},Data_ufcGrid.prototype.posY=function(e){return e*$gameMap.tileHeight()},Data_ufcGrid.prototype.fillGrid=function(e,t){this.getBitmap.fillRect(this.posX(e)+this._lineSize/2,this.posY(t)+this._lineSize/2,$gameMap.tileWidth()-this._lineSize,$gameMap.tileHeight()-this._lineSize,this.getGridColor)},Data_ufcGrid.prototype.clearGrid=function(e,t){this.getBitmap.clearRect(this.posX(e),this.posY(t),$gameMap.tileWidth(),$gameMap.tileHeight())},Data_ufcGrid.prototype.destroy=function(){this._destroy=!0,this.getBitmap.destroy()},Data_ufcGrid.prototype.isDestroyed=function(){return this._destroy},Data_ufcGrid.prototype.getBitmapType=function(e){return this._bitmap[e]},Object.defineProperty(Data_ufcGrid.prototype,"getBitmap",{get:function(){return this._bitmap[this.getType]}}),Object.defineProperty(Data_ufcGrid.prototype,"getType",{get:function(){return this._type}}),Object.defineProperty(Data_ufcGrid.prototype,"getListType",{get:function(){return this._listType}}),Object.defineProperty(Data_ufcGrid.prototype,"getGridColor",{get:function(){switch(this.getType){case TowerDefenseManager.TOWERTYPE.TRAP:return UFC.UFCTD.TOWERSETTINGS.gridTrapColor;default:return UFC.UFCTD.TOWERSETTINGS.gridColor}}}),Game_TDEnemy.prototype=Object.create(Game_Character.prototype),Game_TDEnemy.prototype.constructor=Game_TDEnemy,Game_TDEnemy.prototype.initialize=function(e,t){Game_Character.prototype.initialize.call(this),this._mapId=$gameMap._mapId,this._enemyData=Object.assign({},$dataTDEnemy[e]),this._resistance=this._enemyData.resistance,this._itemDrop=this._enemyData.itemDrop,this._spawn=$dataTDSpawnLocation[this._mapId][t],this._direction=TowerDefenseManager.convertDirection(this._spawn._direction),this._effects={};for(const e in TowerDefenseManager.EFFECTS)this._effects[TowerDefenseManager.EFFECTS[e]]={enable:!1,effect:null};this._x=this._spawn._x,this._y=this._spawn._y,this._realX=this._spawn._x,this._realY=this._spawn._y,this._destroy=!1,this.setDirection(this._direction),this._realMoveSpeed=+this._enemyData.moveSpeed,this._moveSpeed=this._realMoveSpeed,this._moveSpeedEffects={},this._isStun=!1,this._animationPlaying=!1,this._through="true"==this._enemyData.isThrough,this._event=new PIXI.utils.EventEmitter,this._triggerInit=!1,this._triggerWait=0,this._target=null,this._attack={Damage:+this._enemyData.attackDamage,Time:0},this._forceMove=!1},Game_TDEnemy.prototype.isSameType=function(e){return e===TowerDefenseManager.ENEMYTYPE.ALL||e===this._enemyData.enemyType||this._enemyData.enemyType===TowerDefenseManager.ENEMYTYPE.ALL},Game_TDEnemy.prototype.getEnemyData=function(){return this._enemyData},Game_TDEnemy.prototype.isStarting=function(){return!1},Game_TDEnemy.prototype.isTriggerIn=function(){return!1},Game_TDEnemy.prototype.refresh=function(){return!1},Game_TDEnemy.prototype.checkTriggerConfig=function(e){return!e||!(e.exceptEnemy.includes(this._enemyData.id)&&e.exceptEnemy.length>0)&&(!(!e.onlyEnemy.includes(this._enemyData.id)&&e.onlyEnemy.length>0)&&(e.enemyType===TowerDefenseManager.ENEMYTYPE.ALL||e.enemyType===this._enemyData.enemyType||this._enemyData.enemyType===TowerDefenseManager.ENEMYTYPE.ALL))},Game_TDEnemy.prototype.update=function(){if(Game_Character.prototype.update.call(this),this.updateEffects(),this._triggerWait>0&&this._triggerWait--,!this.isMoving()&&this._triggerWait<=0){if(!this._triggerInit){let e=TowerDefenseManager.getTrigger(this._mapId,this._x,this._y);if(e&&this.checkTriggerConfig(e.config)){for(let t in e)switch(t){case TowerDefenseManager.TRIGGERTYPE.DIRECTION:this.setDirection(TowerDefenseManager.convertDirection(e[t])),this._triggerInit=!0;break;case TowerDefenseManager.TRIGGERTYPE.DESTROY:this.triggerDestroy(e[t]),this._triggerInit=!0;break;case TowerDefenseManager.TRIGGERTYPE.WAIT:this._triggerWait=e[t].duration,this._triggerInit=!0}if(this._triggerInit)return}}if(this.updateTrap())return;this.moveStraight(this._direction),this._triggerInit=!1,this._forceMove&&this.setThrough(!1)}},Game_TDEnemy.prototype.updateTrap=function(){let e=this.getTrap();return!!e&&(e.isThrough()?(e.attackTrap(this),this._target=null,!1):(this._attack.Time--,this._attack.Time<=0&&(this._attack.Time=this._enemyData.attackSpeed,this.attack(e)),!0))},Game_TDEnemy.prototype.getTrap=function(){if(this._target){if(!this._target.isDestroyed())return this._target;this._target=null}const e=$gameMap.roundXWithDirection(this._x,this._direction),t=$gameMap.roundYWithDirection(this._y,this._direction);let i=$gameMap.ufcGetTrap(e,t);return i&&!i.isThrough()?this.isSameType(i._towerData._attackType)?(this._target=i,this._target):(this._forceMove=!0,this.setThrough(!0),null):(i=$gameMap.ufcGetTrap(this._x,this._y))&&this.isSameType(i._towerData._attackType)?(this._target=i,this._target):null},Game_TDEnemy.prototype.updateEffects=function(){for(const e in this._effects)if(this._effects[e].effect){if(!this._effects[e].enable){if(this.checkResistance(e)||!this._effects[e].effect.getChanceEffect()){this._effects[e].enable=!1,this._effects[e].effect=null;continue}let t=!1;switch(e){case TowerDefenseManager.EFFECTS.COLD:this.addMoveSpeedEffect(e,-this._realMoveSpeed*(this._effects[e].effect.getEffect()/100),!0);break;case TowerDefenseManager.EFFECTS.POISON:this._effects[e].effect.setEPSCallback(()=>this.attacked({damage:this._effects[e].effect.getEffect()}));break;case TowerDefenseManager.EFFECTS.STUN:this._isStun=!0;break;case TowerDefenseManager.EFFECTS.RAGE:this.addMoveSpeedEffect(e,this._realMoveSpeed*(this._effects[e].effect.getEffect()/100),!1);break;case TowerDefenseManager.EFFECTS.STEAL:AudioManager.playSe({name:UFC.UFCTD.CONFIG.sound.effectSteal,volume:40,pitch:100,pan:0}),TowerDefenseManager.gainGold(this._effects[e].effect.getEffect()),t=!0;break;case TowerDefenseManager.EFFECTS.CRITICAL:this.attacked({damage:this._effects[e].effect.getCriticalDamage()}),t=!0}if(t){this._effects[e].enable=!1,this._effects[e].effect=null;continue}this._event.emit("addEffect",e),this._effects[e].enable=!0}if(this._effects[e].effect.update(),this._effects[e].effect.isDone()){switch(e){case TowerDefenseManager.EFFECTS.COLD:case TowerDefenseManager.EFFECTS.RAGE:this.removeMoveSpeedEffect(e);break;case TowerDefenseManager.EFFECTS.STUN:this._isStun=!1}this._effects[e].enable=!1,this._effects[e].effect=null,this._event.emit("removeEffect",e)}}},Game_TDEnemy.prototype.updateMoveSpeed=function(){let e=this._realMoveSpeed;for(let t in this._moveSpeedEffects)e+=this._moveSpeedEffects[t];this._moveSpeed=e},Game_TDEnemy.prototype.removeMoveSpeedEffect=function(e){delete this._moveSpeedEffects[e],this.updateMoveSpeed()},Game_TDEnemy.prototype.addMoveSpeedEffect=function(e,t,i){if(this._moveSpeedEffects[e]){if(!(this._moveSpeedEffects[e]<t&&i||this._moveSpeedEffects[e]>t&&!i))return;this._moveSpeedEffects[e]=t}else this._moveSpeedEffects[e]=t;this.updateMoveSpeed()},Game_TDEnemy.prototype.distancePerFrame=function(){return this._isStun?0:Game_Character.prototype.distancePerFrame.call(this)},Game_TDEnemy.prototype.triggerDestroy=function(e){e.attack&&this.attackTrigger(e.attackEventId),0!=+e.animationId&&TowerDefenseManager.requestAnimation([this],+e.animationId),this.destroy(!0)},Game_TDEnemy.prototype.attackTrigger=function(e){TowerDefenseManager.requestAnimation([$gameMap._events[e]],+this._enemyData.attackAnimation),TowerDefenseManager.attackTrigger(this._attack.Damage)},Game_TDEnemy.prototype.attacked=function(e){if(this._enemyData.health-=e.damage,this._enemyData.health<=0&&!this._destroy)return this._enemyData.seDead&&AudioManager.playSe({name:this._enemyData.seDead,volume:this._enemyData.seDeadVolume,pitch:100,pan:0}),void this.destroy();if(e.effects&&e.effects.length>0){let t=e.effects;for(const i in t)t[i].damage=e.damage,this._effects[t[i].name].effect=new ufcTowerEffects(t[i])}},Game_TDEnemy.prototype.attack=function(e){TowerDefenseManager.requestAnimation([e],+this._enemyData.attackAnimation),e.attacked({damage:this._attack.Damage})},Game_TDEnemy.prototype.checkResistance=function(e){return this._resistance.length>0&&this._resistance.includes(e)},Game_TDEnemy.prototype.getDropItem=function(){if(this._itemDrop.length>0)for(let e of this._itemDrop){if(e.chance<100){let t=Math.randomInt(100);if(e.chance<t)continue}TowerDefenseManager.gainItem(+e.items,+e.amount)}},Game_TDEnemy.prototype.isMoving=function(){return this._realX!==this._x||this._realY!==this._y},Game_TDEnemy.prototype.destroy=function(e=!1){$gameMap.ufcDestroyEnemy(this),this._destroy=!0,e||(this.getDropItem(),TowerDefenseManager.gainGold(+this._enemyData.gold))},Game_TDEnemy.prototype.isDestroyed=function(){return this._destroy},Object.defineProperty(Game_TDEnemy.prototype,"health",{get:function(){return this._enemyData.health}}),Object.defineProperty(Game_TDEnemy.prototype,"attackSpeed",{get:function(){return this._enemyData.attackSpeed}}),Game_TDTower.prototype=Object.create(Game_Character.prototype),Game_TDTower.prototype.constructor=Game_TDTower,Game_TDTower.prototype.initialize=function(e,t,i=!1){if(Game_Character.prototype.initialize.call(this),this._mapId=t,this._towerData=e,this._attackTime=0,this._x=this._towerData._x,this._y=this._towerData._y,this._realX=this._towerData._x,this._realY=this._towerData._y,this._target=null,this._destroy=!1,this._towerEffectedByAura=[],this._trapAttack=!1,this._trapAttackTimeDefault=60,this._trapAttackTime=this._trapAttackTimeDefault,this._towerData.getType==TowerDefenseManager.TOWERTYPE.TRAP){if(this._pattern=this._towerData._characterIndexX,this._through=this._towerData._through,this._towerData._through&&this.setPriorityType(0),i){let e=$gameMap.ufcTraps();e[this._x]||(e[this._x]=[]),e[this._x][this._y]=this}}else this.getTowerData().checkGetBuffs(),this.getTowerData().isHaveAura()&&this.addAuraEffects()},Game_TDTower.prototype.addAuraEffects=function(){let e=$gameMap._events.filter(e=>e instanceof Game_TDTower&&e!==this&&PIXI.utils.isInRange(e._x,e._y,this._x,this._y,this.getTowerData().getRange()));for(const t of e)t.getTowerData().setBuffs(this.getTowerData().getAuras()),this.addTowerEffectedByAura(t.getTowerData())},Game_TDTower.prototype.addTowerEffectedByAura=function(e){this._towerEffectedByAura.push(e)},Game_TDTower.prototype.getTowerData=function(){return this._towerData},Game_TDTower.prototype.isStarting=function(){return!1},Game_TDTower.prototype.isTriggerIn=function(){return!1},Game_TDTower.prototype.refresh=function(){return!1},Game_TDTower.prototype.update=function(){if(UFC.UFCTD.TOWERSETTINGS.animateTower&&this.getTowerData().getType===TowerDefenseManager.TOWERTYPE.TOWER&&Game_Character.prototype.update.call(this),this._attackTime--,!this._target&&$gameMap.ufcEnemies().length>0&&this.getTowerData().getBaseAttack>0){for(const e of $gameMap.ufcEnemies())if(PIXI.utils.isInRange(e._x,e._y,this._x,this._y,this.getTowerData().getRange())&&!e.isDestroyed()&&e.isSameType(this.getTowerData()._attackType)){this._target=e;break}}else this._target&&(!PIXI.utils.isInRange(this._target.x,this._target.y,this._x,this._y,this.getTowerData().getRange())||this._target.isDestroyed()?this._target=null:this._attackTime<=0&&(this._attackTime=this.getTowerData().getAttackSpeed(),this.attack(this._target)));this._trapAttack&&(this._trapAttackTime--,this._trapAttackTime<=0&&(this._trapAttack=!1))},Game_TDTower.prototype.attack=function(e){let t=$gameMap.ufcProjectiles();$gameMap.ufcAddProjectile(new Game_ufcProjectile(this._x,this._y,e,this.getTowerData().getBulletData(),t))},Game_TDTower.prototype.attackTrap=function(e){TowerDefenseManager.requestAnimation([e],this.getTowerData()._bulletAnimationId),e.attacked(this.getTowerData().getBulletData().damage),this._trapAttack=!0,this.getTowerData()._durability&&(this.getTowerData()._durabilityValue--,this.getTowerData()._durabilityValue<=0&&this.destroy())},Game_TDTower.prototype.attacked=function(e){this.getTowerData()._health-=e.damage,this.getTowerData()._health<=0&&!this._destroy&&this.destroy(!0)},Game_TDTower.prototype.destroy=function(e=!1){if(!e){let e=this.getTowerData()._se;AudioManager.playSe({name:e.Destroy?e.Destroy:UFC.UFCTD.CONFIG.sound.towerDestroy,volume:e.DestroyVolume,pitch:100,pan:0})}if(this._destroy=!0,$gameMap.ufcDestroyTower(this),this.getTowerData().getType!=TowerDefenseManager.TOWERTYPE.TRAP){for(let t of this._towerEffectedByAura)t.resetBuffs(),e||t.checkGetBuffs();this._towerEffectedByAura=[]}else $gameMap.ufcDestroyTrap(this)},Game_TDTower.prototype.getYPattern=function(){return this.getTowerData().getType==TowerDefenseManager.TOWERTYPE.TOWER?0:this._trapAttack?this.getTowerData()._attackIndexY:0},Game_TDTower.prototype.isDestroyed=function(){return this._destroy},Game_TDTower.prototype.isMoving=function(){return!0},Game_TDTower.prototype.actionTower=function(){$gameMessage.setWindowTower(!0),TowerDefenseManager.actionTower(this.getTowerData(),()=>{this.destroy()})},Game_ufcProjectile.prototype=Object.create(Game_Character.prototype),Game_ufcProjectile.prototype.constructor=Game_ufcProjectile,Game_ufcProjectile.prototype.initialize=function(e,t,i,a){Game_Character.prototype.initialize.call(this),this._mapId=$gameMap._mapId,this._target=i,this._x=e,this._y=t,this.damage=a.damage,this.speed=a.speed,this.animationId=a.animationId,this.characterName=a.characterName,this.characterIndex=a.characterIndex,this.characterIndexY=a.characterIndexY,this.canvasX=this.screenX(this._x),this.canvasY=this.screenY(this._y),this.vX=0,this.vY=0,this._destroy=!1,this.rotation=180,this._distCollide=38,this.setDirection(2)},Game_ufcProjectile.prototype.screenX=function(e=this._x){const t=$gameMap.tileWidth();return Math.floor($gameMap.adjustX(e)*t+t/2)},Game_ufcProjectile.prototype.screenY=function(e=this._y){const t=$gameMap.tileHeight();return Math.floor($gameMap.adjustY(e)*t+t/2)},Game_ufcProjectile.prototype.update=function(){Imported.VisuMZ_1_EventsMoveCore?this.baseUpdate():Game_Character.prototype.update.call(this);let e=this.screenY(this._target._realY),t=this.screenX(this._target._realX);this.canvasX=this.screenX(this._x)+this.vX,this.canvasY=this.screenY(this._y)+this.vY,this.rotation=Math.atan2(e-this.canvasY,t-this.canvasX),this.vX+=Math.cos(this.rotation)*(this.speed/60),this.vY+=Math.sin(this.rotation)*(this.speed/60),this.canvasX=this.screenX(this._x)+this.vX,this.canvasY=this.screenY(this._y)+this.vY,(PIXI.utils.dist(this.canvasX,this.canvasY,t,e)<=this._distCollide||this._target.isDestroyed())&&this.destroy()},Game_ufcProjectile.prototype.destroy=function(e=!1){e||(TowerDefenseManager.requestAnimation([this._target],this.animationId),this._target.attacked(this.damage)),$gameMap.ufcDestroyProjectile(this),this._destroy=!0},Game_ufcProjectile.prototype.isMoving=function(){return!0},Game_ufcProjectile.prototype.isDestroyed=function(){return this._destroy},Imported.VisuMZ_1_EventsMoveCore&&(Game_ufcProjectile.prototype.setDirection=function(e){this._direction=e},Game_ufcProjectile.prototype.pattern=function(){return this._pattern<3?this._pattern:1},Game_ufcProjectile.prototype.direction=function(){return this._direction},Game_ufcProjectile.prototype.baseUpdate=function(){this.isStopping()&&this.updateStop(),this.isJumping()?this.updateJump():this.isMoving()&&this.updateMove(),this.updateAnimation()},Game_ufcProjectile.prototype.isSpriteVS8dir=function(){return!1},Game_ufcProjectile.prototype.isPosing=function(){return!1},Game_ufcProjectile.prototype.hasStepAnime=function(){return!1},Game_ufcProjectile.prototype.updatePatternEventsMoveCore=function(){});const Sprite_ufcGrid=function(){this.initialize(...arguments)};(Sprite_ufcGrid.prototype=Object.create(Sprite.prototype)).constructor=Sprite_ufcGrid,Sprite_ufcGrid.prototype.initialize=function(e){switch(this._gridData=$gameMap.ufcGetGrid(),Sprite.prototype.initialize.call(this,this._gridData.getBitmapType(e)),this._type=e,this._type){case TowerDefenseManager.TOWERTYPE.TRAP:this.opacity=UFC.UFCTD.TOWERSETTINGS.gridTrapColorOpacity;break;default:this.opacity=UFC.UFCTD.TOWERSETTINGS.gridColorOpacity}this._gridData._event.on("showGrid",this.setVisible,this),this.visible=!1,this.z=1},Sprite_ufcGrid.prototype.setVisible=function(e){this._gridData.getType===this._type&&(this.visible=e)},Sprite_ufcGrid.prototype.update=function(){Sprite.prototype.update.call(this),this.x=this.screenX(-.5),this.y=this.screenY(-.5),this._gridData.isDestroyed()&&this.destroy()},Sprite_ufcGrid.prototype.screenX=function(e){const t=$gameMap.tileWidth();return Math.floor($gameMap.adjustX(e)*t+t/2)},Sprite_ufcGrid.prototype.screenY=function(e){const t=$gameMap.tileHeight();return Math.floor($gameMap.adjustY(e)*t+t/2)},Sprite_ufcGrid.prototype.destroy=function(){this._gridData._event.removeListener("showGrid",this.setVisible,this),PIXI.Sprite.prototype.destroy.call(this,{children:!0,texture:!0})};const Sprite_ufcProjectile=function(){this.initialize(...arguments)};(Sprite_ufcProjectile.prototype=Object.create(Sprite.prototype)).constructor=Sprite_ufcProjectile,Sprite_ufcProjectile.prototype.initialize=function(e){Sprite.prototype.initialize.call(this),this.initMembers(e)},Sprite_ufcProjectile.prototype.initMembers=function(e){this.anchor.x=.5,this.anchor.y=1,this._projectileData=e,this._balloonDuration=0,this._tilesetId=0,this._upperBody=null,this._lowerBody=null,this.setCharacterBitmap()},Sprite_ufcProjectile.prototype.setSelectPosition=function(){this.move($gameMap.tileWidth()/2,$gameMap.tileHeight())},Sprite_ufcProjectile.prototype.getRangeGraphics=function(){return this._rangeGraphics},Sprite_ufcProjectile.prototype.checkCharacter=function(e){return e==this._projectileData},Sprite_ufcProjectile.prototype.update=function(){Sprite.prototype.update.call(this),this.updateCharacterFrame(),this.updatePosition(),!this._projectileData.isDestroyed()&&this._projectileData||this.destroy()},Sprite_ufcProjectile.prototype.setCharacterBitmap=function(){"?"==this._projectileData.characterName?this.bitmap=ImageManager.loadCharacter(""):this.bitmap=ImageManager.loadCharacter(this._projectileData.characterName),this.updateCharacterFrame()},Sprite_ufcProjectile.prototype.updatePosition=function(){this.x=this._projectileData.canvasX,this.y=this._projectileData.canvasY,this.rotation=this._projectileData.rotation+-90*PIXI.DEG_TO_RAD},Sprite_ufcProjectile.prototype.updateCharacterFrame=function(){const e=this.patternWidth(),t=this.patternHeight(),i=(this.characterBlockX()+this.characterPatternX())*e,a=(this.characterBlockY()+this.characterPatternY())*t;this.setFrame(i,a,e,t)},Sprite_ufcProjectile.prototype.patternWidth=function(){return this._tileId>0?$gameMap.tileWidth():this.bitmap.width/12},Sprite_ufcProjectile.prototype.patternHeight=function(){return this._tileId>0?$gameMap.tileHeight():this.bitmap.height/8},Sprite_ufcProjectile.prototype.characterBlockX=function(){return this._projectileData.characterIndex%4*3},Sprite_ufcProjectile.prototype.characterBlockY=function(){return this._projectileData.characterIndexY},Sprite_ufcProjectile.prototype.characterPatternX=function(){return this._projectileData.pattern()},Sprite_ufcProjectile.prototype.characterPatternY=function(){return(this._projectileData.direction()-2)/2},Sprite_ufcProjectile.prototype.setPosition=function(e,t){let i=$gameMap.positionToCanvas(e,t);this.move(i.x,i.y)};const Sprite_ufcTDEnemy=function(){this.initialize(...arguments)};function Sprite_ufcTDEnemyEffect(){this.initialize(...arguments)}(Sprite_ufcTDEnemy.prototype=Object.create(Sprite.prototype)).constructor=Sprite_ufcTDEnemy,Sprite_ufcTDEnemy.prototype.initialize=function(e){Sprite.prototype.initialize.call(this),this.initMembers(e)},Sprite_ufcTDEnemy.prototype.initMembers=function(e){this.anchor.x=.5,this.anchor.y=1,this._enemy=e,this._enemyData=this._enemy.getEnemyData(),this._balloonDuration=0,this._tilesetId=0,this._upperBody=null,this._lowerBody=null,this._destroy=!1,this.scale.x=this._enemyData.scale,this.scale.y=this._enemyData.scale,this._enemy._event.on("addEffect",this.addEffect,this),this._enemy._event.on("removeEffect",this.removeEffect,this),this.setCharacterBitmap()},Sprite_ufcTDEnemy.prototype.destroy=function(){this._enemy._event.removeListener("addEffect",this.addEffect,this),this._enemy._event.removeListener("removeEffect",this.removeEffect,this),Sprite.prototype.destroy.call(this)},Sprite_ufcTDEnemy.prototype.addEffect=function(e){let t=0;switch(e){case TowerDefenseManager.EFFECTS.COLD:t=10;break;case TowerDefenseManager.EFFECTS.POISON:t=1;break;case TowerDefenseManager.EFFECTS.STUN:t=5;break;case TowerDefenseManager.EFFECTS.RAGE:t=4}this.addChild(new Sprite_ufcTDEnemyEffect(e,t,0,25))},Sprite_ufcTDEnemy.prototype.removeEffect=function(e){for(const t of this.children)if(t._name==e){t.destroy();break}},Sprite_ufcTDEnemy.prototype.setSelectPosition=function(){this.move($gameMap.tileWidth()/2,$gameMap.tileHeight())},Sprite_ufcTDEnemy.prototype.getRangeGraphics=function(){return this._rangeGraphics},Sprite_ufcTDEnemy.prototype.checkCharacter=function(e){return e==this._enemy},Sprite_ufcTDEnemy.prototype.update=function(){this._destroy||(Sprite.prototype.update.call(this),this.updateCharacterFrame(),this.updatePosition(),this._enemy.isDestroyed()&&this.hide(),!this._enemy.isAnimationPlaying()&&this._enemy.isDestroyed()&&this.destroyEnemy())},Sprite_ufcTDEnemy.prototype.destroyEnemy=function(){$gameMap.ufcDestroyCharacterSprite(this),this._destroy=!0,SceneManager.getSpriteSetMap().removeTargetFromAnimation(this),this.destroy()},Sprite_ufcTDEnemy.prototype.setCharacterBitmap=function(){this.bitmap=ImageManager.loadCharacter(this._enemyData.characterName),this._isBigCharacter=!1,this.updateCharacterFrame()},Sprite_ufcTDEnemy.prototype.updatePosition=function(){this.x=this._enemy.screenX(),this.y=this._enemy.screenY(),this.z=this._enemy.screenZ()},Sprite_ufcTDEnemy.prototype.updateCharacterFrame=function(){const e=this.patternWidth(),t=this.patternHeight(),i=(this.characterBlockX()+this.characterPatternX())*e,a=(this.characterBlockY()+this.characterPatternY())*t;this.setFrame(i,a,e,t)},Sprite_ufcTDEnemy.prototype.patternWidth=function(){return this._tileId>0?$gameMap.tileWidth():this._isBigCharacter?this.bitmap.width/3:this.bitmap.width/12},Sprite_ufcTDEnemy.prototype.patternHeight=function(){return this._tileId>0?$gameMap.tileHeight():this._isBigCharacter?this.bitmap.height/4:this.bitmap.height/8},Sprite_ufcTDEnemy.prototype.characterBlockX=function(){if(this._isBigCharacter)return 0;return this._enemyData.characterIndex%4*3},Sprite_ufcTDEnemy.prototype.characterBlockY=function(){if(this._isBigCharacter)return 0;{const e=this._enemyData.characterIndex;return 4*Math.floor(e/4)}},Sprite_ufcTDEnemy.prototype.characterPatternX=function(){return this._enemy.pattern()},Sprite_ufcTDEnemy.prototype.characterPatternY=function(){return(this._enemy.direction()-2)/2},Sprite_ufcTDEnemy.prototype.setPosition=function(e,t){let i=$gameMap.positionToCanvas(e,t);this.move(i.x,i.y)},Sprite_ufcTDEnemyEffect.prototype=Object.create(Sprite.prototype),Sprite_ufcTDEnemyEffect.prototype.constructor=Sprite_ufcTDEnemyEffect,Sprite_ufcTDEnemyEffect.prototype.initialize=function(e,t,i,a){Sprite.prototype.initialize.call(this),this.initMembers(e,t,i,a),this.loadBitmap()},Sprite_ufcTDEnemyEffect.prototype.initMembers=function(e,t,i=0,a=0){this._name=e,this._overlayIndex=t,this._animationCount=0,this._pattern=0,this.anchor.x=.5,this.anchor.y=1,this.x=i,this.y=a},Sprite_ufcTDEnemyEffect.prototype.loadBitmap=function(){this.bitmap=ImageManager.loadSystem("States"),this.setFrame(0,0,0,0)},Sprite_ufcTDEnemyEffect.prototype.update=function(){Sprite.prototype.update.call(this),this._animationCount++,this._animationCount>=this.animationWait()&&(this.updatePattern(),this.updateFrame(),this._animationCount=0)},Sprite_ufcTDEnemyEffect.prototype.animationWait=function(){return 8},Sprite_ufcTDEnemyEffect.prototype.updatePattern=function(){this._pattern++,this._pattern%=8},Sprite_ufcTDEnemyEffect.prototype.updateFrame=function(){if(this._overlayIndex>0){const e=96,t=96,i=this._pattern*e,a=(this._overlayIndex-1)*t;this.setFrame(i,a,e,t)}else this.setFrame(0,0,0,0)};const Sprite_ufcTDTower=function(){this.initialize(...arguments)};function TowerDefenseManager(){throw new Error("This is a static class")}(Sprite_ufcTDTower.prototype=Object.create(Sprite.prototype)).constructor=Sprite_ufcTDTower,Sprite_ufcTDTower.prototype.initialize=function(e){Sprite.prototype.initialize.call(this),this.initMembers(e)},Sprite_ufcTDTower.prototype.initMembers=function(e){this.anchor.x=.5,this.anchor.y=1,this._tower=e,this._towerData=e.getTowerData(),this._balloonDuration=0,this._tilesetId=0,this._upperBody=null,this._lowerBody=null,this._range=this._tower.getTowerData().getRange(),this.resetRangeGraphics(),this.setCharacterBitmap(),this._towerData._placeMode&&this.setSelectPosition(),this._towerData._event.on("setRangeVisibility",this.setRangeVisibility,this)},Sprite_ufcTDTower.prototype.resetRangeGraphics=function(){let e=new PIXI.Graphics,t=2*this._range+1;this._towerData.isHaveAura()?e.beginFill(UFC.UFCTD.TOWERSETTINGS.auraRangeColor,UFC.UFCTD.TOWERSETTINGS.auraRangeOpacity):e.beginFill(UFC.UFCTD.TOWERSETTINGS.attackRangeColor,UFC.UFCTD.TOWERSETTINGS.attackRangeOpacity);for(let i=0;i<t;i++)for(let a=0;a<t;a++)e.drawRect(this.posX(i)+3,this.posY(a)+3,$gameMap.tileWidth()-6,$gameMap.tileHeight()-6);e.endFill();let i=Graphics.app.renderer.generateTexture(e);this._rangeGraphics?this._rangeGraphics.texture=i:(this._rangeGraphics=new PIXI.Sprite(i),this._rangeGraphics.anchor.x=.5,this._rangeGraphics.anchor.y=.5,this._rangeGraphics.x=0,this._rangeGraphics.y=-$gameMap.tileHeight()/2,this.addChild(this._rangeGraphics)),e.destroy(),this._rangeGraphics.visible=!1},Sprite_ufcTDTower.prototype.setSelectPosition=function(){this.move($gameMap.tileWidth()/2,$gameMap.tileHeight())},Sprite_ufcTDTower.prototype.getRangeGraphics=function(){return this._rangeGraphics},Sprite_ufcTDTower.prototype.checkCharacter=function(e){return e==this._tower},Sprite_ufcTDTower.prototype.update=function(){Sprite.prototype.update.call(this),this.updateCharacterFrame(),this._towerData._placeMode||(this.updatePosition(),this._tower.isDestroyed()&&this.destroySprite(),Imported.VisuMZ_1_EventsMoveCore&&this._tower.update())},Sprite_ufcTDTower.prototype.destroySprite=function(){$gameMap.ufcDestroyCharacterSprite(this),this.destroy()},Sprite_ufcTDTower.prototype.setCharacterBitmap=function(){this.bitmap=ImageManager.loadCharacter(this._towerData._character),this._isBigCharacter=ImageManager.isBigCharacter(this._towerData._character),this.updateCharacterFrame()},Sprite_ufcTDTower.prototype.updatePosition=function(){this.x=this._tower.screenX(),this.y=this._tower.screenY(),this.z=this._tower.screenZ()},Sprite_ufcTDTower.prototype.updateCharacterFrame=function(){const e=this.patternWidth(),t=this.patternHeight(),i=(this.characterBlockX()+this.characterPatternX())*e,a=(this.characterBlockY()+this.characterPatternY())*t;this.setFrame(i,a,e,t)},Sprite_ufcTDTower.prototype.patternWidth=function(){return this._tileId>0?$gameMap.tileWidth():this._isBigCharacter?this.bitmap.width/3:this.bitmap.width/12},Sprite_ufcTDTower.prototype.patternHeight=function(){return this._tileId>0?$gameMap.tileHeight():this._isBigCharacter?this.bitmap.height/4:this.bitmap.height/8},Sprite_ufcTDTower.prototype.characterBlockX=function(){if(this._isBigCharacter)return 0;return this._towerData._characterIndex%4*3},Sprite_ufcTDTower.prototype.characterBlockY=function(){if(this._isBigCharacter)return 0;{const e=this._towerData._characterIndex;return 4*Math.floor(e/4)}},Sprite_ufcTDTower.prototype.characterPatternX=function(){return this._tower.pattern()},Sprite_ufcTDTower.prototype.characterPatternY=function(){return this._tower.getYPattern()},Sprite_ufcTDTower.prototype.setRangeVisibility=function(e){let t=this._tower.getTowerData().getRange();e&&this._range!=t&&(this._range=t,this.resetRangeGraphics()),this._rangeGraphics.visible=e},Sprite_ufcTDTower.prototype.setPosition=function(e,t){let i=$gameMap.positionToCanvas(e,t);this.move(i.x,i.y)},Sprite_ufcTDTower.prototype.posX=function(e){return e*$gameMap.tileWidth()},Sprite_ufcTDTower.prototype.posY=function(e){return e*$gameMap.tileHeight()},Sprite_ufcTDTower.prototype.destroy=function(e){this._towerData._event.removeListener("setRangeVisibility",this.setRangeVisibility,this),this._rangeGraphics.destroy({texture:!0,baseTexture:!0}),Sprite.prototype.destroy.call(this,e)},PIXI.utils.dist=function(e,t,i,a){return Math.sqrt(Math.pow(e-i,2)+Math.pow(t-a,2))},PIXI.utils.randomArray=function(e){return e[Math.floor(Math.random()*e.length)]},PIXI.utils.isInRange=function(e,t,i,a,o){return e<=i+o&&e>=i-o&&t<=a+o&&t>=a-o},PIXI.utils.lerp=function(e,t,i){return(1-i)*e+i*t},SceneManager.getScene=function(){return this._scene},SceneManager.getSpriteSetMap=function(){return this.getScene()._spriteset},UFC.UFCTD.ALIAS._Datamanager_createGameObjects=DataManager.createGameObjects,DataManager.createGameObjects=function(){UFC.UFCTD.ALIAS._Datamanager_createGameObjects.call(this),TowerDefenseManager.initialize()},UFC.UFCTD.ALIAS._Window_ShopStatus_refresh=Window_ShopStatus.prototype.refresh,Window_ShopStatus.prototype.refresh=function(){UFC.UFCTD.ALIAS._Window_ShopStatus_refresh.call(this),this._item&&this.isTowerItem()&&this.drawTowerInfo(0,60,"center")},Window_ShopStatus.prototype.drawTowerInfo=function(e,t,i){let a=this._item.ufcTower,o=ImageManager.loadCharacter(a.character),n=a.characterindex,r=o.width/12,s=o.height/8,c=(n%4*3+1)*r,h=(4*Math.floor(n/4)+0)*s;"center"==i&&(e+=this.width/2,e-=1.5*r/2,e-=this.itemPadding()),this.contents.blt(o,c,h,r,s,e,t,1.5*r,1.5*s);let p=t+100,d=["Attack","Range","Attack Speed","Bullet Speed"],l=[a.attack,a.range,a.attackspeed,a.bulletspeed];this.contents.fontSize=20;for(let e=0;e<d.length;e++)this.resetTextColor(),this.drawText(d[e],10,p+30*e,150),this.changeTextColor(ColorManager.systemColor()),this.drawText(l[e],190,p+30*e,150);this.resetTextColor(),this.drawText("Effect",10,p+30*d.length,150);let u="\\FS[17]\n";a.note||(u+="\\C[16]None"),this.drawTextEx(u+a.note,10,p+30*d.length-5,200),this.resetFontSettings()},Window_ShopStatus.prototype.isTowerItem=function(){return!!this._item.ufcTower},UFC.UFCTD.ALIAS._Scene_Shop_popScene=Scene_Shop.prototype.popScene,Scene_Shop.prototype.popScene=function(){TowerDefenseManager.openShop(!1),UFC.UFCTD.ALIAS._Scene_Shop_popScene.call(this)},UFC.UFCTD.ALIAS._Window_ShopBuy_price=Window_ShopBuy.prototype.price,Window_ShopBuy.prototype.price=function(e){if(TowerDefenseManager.isShopOpen&&1!=UFC.UFCTD.SHOPGUISETTINGS.multiplier){let t=UFC.UFCTD.ALIAS._Window_ShopBuy_price.call(this,e)*UFC.UFCTD.SHOPGUISETTINGS.multiplier;if(0!=UFC.UFCTD.SHOPGUISETTINGS.roundPrice){let e=Math.pow(10,UFC.UFCTD.SHOPGUISETTINGS.roundPrice);t=Math.ceil(t/e)*e}return t}return UFC.UFCTD.ALIAS._Window_ShopBuy_price.call(this,e)},UFC.UFCTD.ALIAS._Window_ShopCommand_makeCommandList=Window_ShopCommand.prototype.makeCommandList,Window_ShopCommand.prototype.makeCommandList=function(){TowerDefenseManager.isShopOpen?(this.addCommand(TextManager.buy,"buy"),this.addCommand(TextManager.cancel,"cancel")):UFC.UFCTD.ALIAS._Window_ShopCommand_makeCommandList.call(this)},UFC.UFCTD.ALIAS._Window_ShopCommand_maxCols=Window_ShopCommand.prototype.maxCols,Window_ShopCommand.prototype.maxCols=function(){return TowerDefenseManager.isShopOpen?2:UFC.UFCTD.ALIAS._Window_ShopCommand_maxCols.call(this)},Game_Character.prototype.moveAwayFromHere=function(){const e=[4,2,6,8];for(let t=0;t<e.length;t++)if(this.canPass(this.x,this.y,e[t]))return this.moveStraight(e[t]),!0;return!1},UFC.UFCTD.ALIAS._Game_Player_triggerButtonAction=Game_Player.prototype.triggerButtonAction,Game_Player.prototype.triggerButtonAction=function(){return TowerDefenseManager.isActive&&Input.isTriggered("ok")&&TowerDefenseManager.getState==TowerDefenseManager.STATE.BUILD&&!this.getGuideAction().isBlocked()?(this.getGuideAction().updateBlocked(!0),this.getGuideAction().isBlocked()||TowerDefenseManager.placeTower(),!0):!(!Input.isTriggered("ok")||!this.checkEventTower())||UFC.UFCTD.ALIAS._Game_Player_triggerButtonAction.call(this,...arguments)},UFC.UFCTD.ALIAS._Game_Player_moveByInput=Game_Player.prototype.moveByInput,Game_Player.prototype.moveByInput=function(){TowerDefenseManager.isActive&&TowerDefenseManager.getState==TowerDefenseManager.STATE.BUILD&&this.getInputDirection()>0&&this.getGuideAction().isMouseMode&&this.getGuideAction().setMouseMode(!1),UFC.UFCTD.ALIAS._Game_Player_moveByInput.call(this)},UFC.UFCTD.ALIAS._Game_Player_executeMove=Game_Player.prototype.executeMove,Game_Player.prototype.executeMove=function(){if(!this.towerAction())return UFC.UFCTD.ALIAS._Game_Player_executeMove.call(this,...arguments)},Game_Player.prototype.towerAction=function(){if(TowerDefenseManager.isActive&&$gameTemp.isDestinationValid()&&TowerDefenseManager.getState==TowerDefenseManager.STATE.BUILD){const e=$gameTemp.destinationX(),t=$gameTemp.destinationY();if($gameMap.distance(this.x,this.y,e,t)<=1)return this.turnTowardCharacter({x:e,y:t}),this.getGuideAction().updateBlocked(),this.getGuideAction().isBlocked()||(this.getGuideAction().updateBlocked(!0),this.getGuideAction().isBlocked()||TowerDefenseManager.placeTower(),$gameTemp.clearDestination()),this.getGuideAction().clearTrigger(),!0}return!1},UFC.UFCTD.ALIAS._Game_Player_update=Game_Player.prototype.update,Game_Player.prototype.update=function(){if(UFC.UFCTD.ALIAS._Game_Player_update.call(this,...arguments),TowerDefenseManager.isActive&&TouchInput.isTriggered()&&TowerDefenseManager.getState==TowerDefenseManager.STATE.BUILD){const e=$gameMap.canvasToMapX(TouchInput.x),t=$gameMap.canvasToMapY(TouchInput.y);if(this.pos(e,t)){this.moveAwayFromHere()&&$gameTemp.setDestination(e,t)}}},UFC.UFCTD.ALIAS._Game_Player_triggerTouchActionD2=Game_Player.prototype.triggerTouchActionD2,Game_Player.prototype.triggerTouchActionD2=function(e,t){return!!this.checkEventTower(e,t)||UFC.UFCTD.ALIAS._Game_Player_triggerTouchActionD2.call(this,...arguments)},Game_Player.prototype.checkEventTower=function(e,t){if(!TowerDefenseManager.isActive||TowerDefenseManager.getState!=TowerDefenseManager.STATE.IDLE)return!1;let i=e,a=t;if(!i||!a){if($gameMap.isEventRunning())return!1;i=$gameMap.roundXWithDirection(this._x,this._direction),a=$gameMap.roundYWithDirection(this._y,this._direction)}const o=$gameMap.checkTDTower(i,a,!0);return!!o&&(o[0].actionTower(),!0)},UFC.UFCTD.ALIAS._Scene_Boot_loadSystemImages=Scene_Boot.prototype.loadSystemImages,Scene_Boot.prototype.loadSystemImages=function(){UFC.UFCTD.ALIAS._Scene_Boot_loadSystemImages.call(this),ImageManager.loadSystem("TDShopIcon")},UFC.UFCTD.ALIAS._Scene_Map_onMapTouch=Scene_Map.prototype.onMapTouch,Scene_Map.prototype.onMapTouch=function(){if(!TowerDefenseManager.isActive||!UFC.UFCTD.HUDGUI.MESSAGE.isBusy())return UFC.UFCTD.ALIAS._Scene_Map_onMapTouch.call(this)},UFC.UFCTD.ALIAS._Scene_Map_updateCallMenu=Scene_Map.prototype.updateCallMenu,Scene_Map.prototype.updateCallMenu=function(){UFC.UFCTD.ALIAS._Scene_Map_updateCallMenu.call(this),TowerDefenseManager.isActive&&!this.isMenuEnabled()&&TowerDefenseManager.getState==TowerDefenseManager.STATE.BUILD&&this.isMenuCalled()&&TowerDefenseManager.cancelSelect()},UFC.UFCTD.ALIAS._Scene_Map_createAllWindows=Scene_Map.prototype.createAllWindows,Scene_Map.prototype.createAllWindows=function(){UFC.UFCTD.ALIAS._Scene_Map_createAllWindows.call(this),TowerDefenseManager.isConfigured&&this.createHUDTD()},Scene_Map.prototype.createHUDTD=function(){UFC.UFCTD.HUDGUI.ITEMSLOT=new Window_GUIItemSlot,this.addWindow(UFC.UFCTD.HUDGUI.ITEMSLOT);let e=300,t=240;UFC.UFCTD.HUDGUI.ITEMSLOT.visible=TowerDefenseManager.getGUIItemSlot,UFC.UFCTD.HUDGUI.TOWERACTION=new Window_TDAction(new Rectangle(360,Graphics.boxHeight-t,e,t)),this.addWindow(UFC.UFCTD.HUDGUI.TOWERACTION),UFC.UFCTD.HUDGUI.GOLDWINDOW=new Window_TDGold(new Rectangle(0,0,200,this.calcWindowHeight(1,!0))),this.addWindow(UFC.UFCTD.HUDGUI.GOLDWINDOW),UFC.UFCTD.HUDGUI.GOLDWINDOW.visible=TowerDefenseManager.getHUDGold;UFC.UFCTD.HUDGUI.HEALTHWINDOW=new Window_TDHealth(new Rectangle(Graphics.boxWidth/2-100,-10,200,80)),this.addWindow(UFC.UFCTD.HUDGUI.HEALTHWINDOW),UFC.UFCTD.HUDGUI.HEALTHWINDOW.visible=TowerDefenseManager.getHUDHealth,UFC.UFCTD.SHOPGUISETTINGS.enable&&(UFC.UFCTD.HUDGUI.SHOP=new Window_TDShop,this.addWindow(UFC.UFCTD.HUDGUI.SHOP),UFC.UFCTD.HUDGUI.SHOP.visible=TowerDefenseManager.getGUIItemSlot)},UFC.UFCTD.ALIAS._Game_Interpreter_command125=Game_Interpreter.prototype.command125,Game_Interpreter.prototype.command125=function(){return UFC.UFCTD.ALIAS._Game_Interpreter_command125.apply(this,arguments),TowerDefenseManager.updateHUDGold(),!0},UFC.UFCTD.ALIAS._Game_Message_clear=Game_Message.prototype.clear,Game_Message.prototype.clear=function(){UFC.UFCTD.ALIAS._Game_Message_clear.call(this),this._windowTowerActionShow=!1},UFC.UFCTD.ALIAS._Game_Message_isBusy=Game_Message.prototype.isBusy,Game_Message.prototype.isBusy=function(){return this._windowTowerActionShow||UFC.UFCTD.ALIAS._Game_Message_isBusy.call(this)},Game_Message.prototype.isBusyDefault=function(){return UFC.UFCTD.ALIAS._Game_Message_isBusy.call(this)},Game_Message.prototype.setWindowTower=function(e){this._windowTowerActionShow=e},UFC.UFCTD.ALIAS._Game_Map_initialize=Game_Map.prototype.initialize,Game_Map.prototype.initialize=function(){UFC.UFCTD.ALIAS._Game_Map_initialize.apply(this,arguments),this._towerDefenseWave=[],this._towerDefenseEnemy=[],this._towerDefenseProjectile=[],this._towerDefenseTraps=[],this._towerDefenseGrid=null},Game_Map.prototype.setupTDGrid=function(e){this._towerDefenseGrid=new Data_ufcGrid(e)},Game_Map.prototype.ufcGetGrid=function(){return this._towerDefenseGrid&&null!==this._towerDefenseGrid.getType&&!this._towerDefenseGrid.getBitmap._canvas&&this._towerDefenseGrid.refreshBitmap(),this._towerDefenseGrid},Game_Map.prototype.ufcCalcGrid=function(){this.ufcGetGrid().calcGrid()},Game_Map.prototype.ufcAddCharacterSprites=function(e){const t=SceneManager.getSpriteSetMap();let i=t._characterSprites.push(e);t._tilemap.addChild(t._characterSprites[i-1])},Game_Map.prototype.getCharacterSprites=function(){return SceneManager.getSpriteSetMap()._characterSprites},Game_Map.prototype.ufcAddProjectile=function(e){const t=SceneManager.getSpriteSetMap();let i=this._towerDefenseProjectile.push(e);t._tilemap.addChild(new Sprite_ufcProjectile(this._towerDefenseProjectile[i-1]))},Game_Map.prototype.ufcAddTower=function(e){let t=this._events.push(new Game_TDTower(e,this._mapId,!0));this.ufcAddCharacterSprites(new Sprite_ufcTDTower(this._events[t-1]))},Game_Map.prototype.ufcSpawnEnemy=function(e,t){let i=this._towerDefenseEnemy.push(new Game_TDEnemy(e,t));this.ufcAddCharacterSprites(new Sprite_ufcTDEnemy(this._towerDefenseEnemy[i-1]))},Game_Map.prototype.ufcDestroyCharacterSprite=function(e){return this.getCharacterSprites().remove(e)},Game_Map.prototype.ufcDestroyProjectile=function(e){return this._towerDefenseProjectile.remove(e)},Game_Map.prototype.ufcDestroyEnemy=function(e){return this._towerDefenseEnemy.remove(e)},Game_Map.prototype.ufcDestroyTower=function(e){return this._events.remove(e)},Game_Map.prototype.ufcDestroyTrap=function(e){delete this._towerDefenseTraps[e._x][e._y]},Game_Map.prototype.ufcGetTrap=function(e,t){return this.ufcTraps()[e]?this.ufcTraps()[e][t]:null},Game_Map.prototype.ufcTraps=function(){return this._towerDefenseTraps},Game_Map.prototype.ufcEnemies=function(){return this._towerDefenseEnemy},Game_Map.prototype.ufcProjectiles=function(){return this._towerDefenseProjectile},Game_Map.prototype.isWaveEnd=function(){return this.ufcEnemies().length<=0&&this._towerDefenseWave.length<=0},Game_Map.prototype.xToCanvas=function(e){return this.adjustX(e)*this.tileWidth()},Game_Map.prototype.yToCanvas=function(e){return this.adjustY(e)*this.tileWidth()},Game_Map.prototype.positionToCanvas=function(e,t){return{x:this.xToCanvas(e),y:this.yToCanvas(t)}},UFC.UFCTD.ALIAS._Game_Map_update=Game_Map.prototype.update,Game_Map.prototype.update=function(e){UFC.UFCTD.ALIAS._Game_Map_update.call(this,e),TowerDefenseManager.isActive&&(this.updateTowerDefenseWave(),this.updateTowerDefenseEnemy(),this.updateProjectile(),this.updateGrid())},Game_Map.prototype.addTowerDefenseNewWave=function(e){this._towerDefenseWave.push(new ufcTowerWaveData(e))},Game_Map.prototype.updateTowerDefenseWave=function(){if(this._towerDefenseWave.length>0){let e=this._towerDefenseWave;for(let t=0;t<e.length;t++)e[t].update(),e[t].isSpawnEnemy()&&(this.ufcSpawnEnemy(...e[t].getEnemy()),e[t].isDone()&&(e.splice(t,1),t--))}},Game_Map.prototype.updateTowerDefenseEnemy=function(){for(const e of this.ufcEnemies())e.update()},Game_Map.prototype.updateProjectile=function(){for(const e of this.ufcProjectiles())e.isDestroyed()||e.update()},Game_Map.prototype.updateGrid=function(){this._towerDefenseGrid.updateEvents()},UFC.UFCTD.ALIAS._Game_Map_refresh=Game_Map.prototype.refresh,Game_Map.prototype.refresh=function(){TowerDefenseManager.isActive&&UFC.UFCTD.HUDGUI.ITEMSLOT&&UFC.UFCTD.HUDGUI.ITEMSLOT.refresh(),UFC.UFCTD.ALIAS._Game_Map_refresh.call(this)},Game_Map.prototype.checkTDTower=function(e,t,i=!1){let a=this._events.filter(i=>i instanceof Game_TDTower&&i.pos(e,t));return a.length>0&&(!i||a)},Spriteset_Map.prototype.checkLimitAnimation=function(){return this._animationSprites.length>TowerDefenseManager.getLimitAnimation&&0!=TowerDefenseManager.getLimitAnimation},Spriteset_Map.prototype.removeTargetFromAnimation=function(e){for(const t of this._animationSprites)for(let i=0;i<t._targets.length;i++)t._targets[i]==e&&(t._targets.splice(i,1),i--)},UFC.UFCTD.ALIAS._Spriteset_Map_createCharacters=Spriteset_Map.prototype.createCharacters,Spriteset_Map.prototype.createCharacters=function(){if(UFC.UFCTD.ALIAS._Spriteset_Map_createCharacters.call(this),!TowerDefenseManager.isActive)return;let e=$gameMap._events.filter(e=>e instanceof Game_TDTower);for(const t of e)this._tilemap.addChild(new Sprite_ufcTDTower(t));for(const e of $gameMap.ufcEnemies()){let t=this._characterSprites.push(new Sprite_ufcTDEnemy(e));this._tilemap.addChild(this._characterSprites[t-1])}for(const e of $gameMap.ufcProjectiles())this._tilemap.addChild(new Sprite_ufcProjectile(e));let t=$gameMap.ufcGetGrid(),i=t.getType;for(let e of t.getListType)this._tilemap.addChild(new Sprite_ufcGrid(e));t.setType(i),TowerDefenseManager.getState!=TowerDefenseManager.STATE.IDLE&&TowerDefenseManager.selectTowerMode()},UFC.UFCTD.ALIAS._Game_Party_initAllItems=Game_Party.prototype.initAllItems,Game_Party.prototype.initAllItems=function(){UFC.UFCTD.ALIAS._Game_Party_initAllItems.call(this),this._towers={}},UFC.UFCTD.ALIAS._Game_Party_itemContainer=Game_Party.prototype.itemContainer,Game_Party.prototype.itemContainer=function(e){return e&&(e.ufcTower||e.istowerdata)?this._towers:UFC.UFCTD.ALIAS._Game_Party_itemContainer.call(this,e)},Game_Party.prototype.towers=function(){return Object.keys(this._towers).map(e=>$dataItems[e].ufcTower)},Imported.VisuMZ_1_EventsMoveCore&&(Game_Player.prototype.executeMoveDir8=function(){if(!this.towerAction())return Game_Character.prototype.executeMoveDir8.call(this,...arguments)},UFC.UFCTD.ALIAS._Game_Player_canPass=Game_Player.prototype.canPass,Game_Player.prototype.canPass=function(e,t,i){const a=$gameMap.roundXWithDirection(e,i),o=$gameMap.roundYWithDirection(t,i);return!$gameMap.checkTDTower(a,o)&&UFC.UFCTD.ALIAS._Game_Player_canPass.call(this,...arguments)}),TowerDefenseManager.initialize=function(){this._active=!1,this._config=!1,this._shopOpen=!1,this._HUDGold=!1,this._HUDHealth=!1,this._GUIItemSlot=!1,this._state=TowerDefenseManager.STATE.IDLE,this._selectedUFCTD=null,this._limitAnimation=0,this._controlBuildingMouse=!1,this._cacheSprite=[],this.addTowerList(),UFC.UFCTD.DEBUGMODE.enable&&this.debugMode()},TowerDefenseManager.debugMode=function(){UFC.UFCTD.DEBUGMODE.CONFIG||(UFC.UFCTD.DEBUGMODE.CONFIG={showRange:!1},window.addEventListener("keydown",e=>{1==e.key&&(Graphics.app.ticker.speed=UFC.UFCTD.DEBUGMODE.tickerSpeed)},!1),window.addEventListener("keyup",e=>{1==e.key&&(Graphics.app.ticker.speed=1),2==e.key&&(UFC.UFCTD.DEBUGMODE.CONFIG.showRange=!UFC.UFCTD.DEBUGMODE.CONFIG.showRange,$gameMap._events.filter(e=>e instanceof Game_TDTower).forEach(e=>e.getTowerData().setRangeVisibility(UFC.UFCTD.DEBUGMODE.CONFIG.showRange))),3==e.key&&($gameVariables.setValue(UFC.UFCTD.CONFIG.healthVarId,99999),TowerDefenseManager.updateHUDHealth(),TowerDefenseManager.gainGold(99999999)),4==e.key&&this.setLimitAnimation(UFC.UFCTD.DEBUGMODE.limitAnimation)},!1))},TowerDefenseManager.TOWERTYPE={TOWER:"tower",TRAP:"trap"},TowerDefenseManager.AURATYPEMODE={FIXED:"fixed",PERCENTAGE:"percentage"},TowerDefenseManager.AURATYPE={ATTACK:"attack",ATTACKSPEED:"attackspeed",RANGE:"range"},TowerDefenseManager.ENEMYTYPE={AIR:"air",GROUND:"ground",ALL:"all"},TowerDefenseManager.TRIGGERTYPE={DESTROY:"destroy",DIRECTION:"direction",WAIT:"wait",CONFIG:"config"},TowerDefenseManager.STATE={IDLE:"idle",BUILD:"build"},TowerDefenseManager.EFFECTS={COLD:"cold",POISON:"poison",STUN:"stun",RAGE:"rage",STEAL:"steal",CRITICAL:"critical"},TowerDefenseManager.setLimitAnimation=function(e){this._limitAnimation=e},TowerDefenseManager.attackTrigger=function(e){let t=this.getHUDHealthValue;$gameVariables.setValue(UFC.UFCTD.CONFIG.healthVarId,t-e),t-e<=0&&$gameSwitches.setValue(UFC.UFCTD.CONFIG.gameOverSwitchId,!0),TowerDefenseManager.updateHUDHealth()},TowerDefenseManager.requestAnimation=function(e,t){SceneManager.getSpriteSetMap().checkLimitAnimation()||$gameTemp.requestAnimation(e,t)},TowerDefenseManager.showGUIItemSlot=function(e){this.isActive&&(this._GUIItemSlot="true"==e.show,UFC.UFCTD.HUDGUI.ITEMSLOT.visible=this._GUIItemSlot,UFC.UFCTD.SHOPGUISETTINGS.enable&&(UFC.UFCTD.HUDGUI.SHOP.visible=this._GUIItemSlot),this._GUIItemSlot?UFC.UFCTD.HUDGUI.ITEMSLOT.open():UFC.UFCTD.HUDGUI.ITEMSLOT.close())},TowerDefenseManager.showHUDTDGold=function(e){this.isActive&&(this._HUDGold="true"==e.show,UFC.UFCTD.HUDGUI.GOLDWINDOW.visible=this._HUDGold)},TowerDefenseManager.showHUDTDHealth=function(e){this.isActive&&(this._HUDHealth="true"==e.show,UFC.UFCTD.HUDGUI.HEALTHWINDOW.visible=this._HUDHealth)},TowerDefenseManager.gainGold=function(e){$gameParty.gainGold(e),this.updateHUDGold()},TowerDefenseManager.gainItem=function(e,t){$gameParty.gainItem($dataItems[e],t)},TowerDefenseManager.updateHUDGold=function(){this.isActive&&UFC.UFCTD.HUDGUI.GOLDWINDOW&&!UFC.UFCTD.HUDGUI.GOLDWINDOW._destroyed&&UFC.UFCTD.HUDGUI.GOLDWINDOW.refresh()},TowerDefenseManager.updateHUDHealth=function(){this.isActive&&UFC.UFCTD.HUDGUI.HEALTHWINDOW&&!UFC.UFCTD.HUDGUI.HEALTHWINDOW._destroyed&&UFC.UFCTD.HUDGUI.HEALTHWINDOW.refresh()},TowerDefenseManager.updateHUD=function(){this.updateHUDGold(),this.updateHUDHealth()},TowerDefenseManager.config=function(e){SceneManager.getScene().createHUDTD();let t=Object.keys(TowerDefenseManager.TOWERTYPE).map(e=>TowerDefenseManager.TOWERTYPE[e]);$gameMap.setupTDGrid(t);const i=SceneManager.getSpriteSetMap();for(let e of t)i._tilemap.addChild(new Sprite_ufcGrid(e));$gamePlayer.getGuideAction().setType(TowerDefenseManager.TOWERTYPE.TOWER);let a=JSON.parse(e.onlyTerrain);a&&a.length>0&&(a=a.map(Number),$gamePlayer.getGuideAction().setOnlyTerrain(a));let o=JSON.parse(e.exceptTerrain);o&&o.length>0&&(o=o.map(Number),$gamePlayer.getGuideAction().setExceptTerrain(o));let n=JSON.parse(e.onlyRegionID);n&&n.length>0&&(n=n.map(Number),$gamePlayer.getGuideAction().setOnlyRegion(n));let r=JSON.parse(e.exceptRegionID);r&&r.length>0&&(r=r.map(Number),$gamePlayer.getGuideAction().setExceptRegion(r)),$gamePlayer.getGuideAction().setType(TowerDefenseManager.TOWERTYPE.TRAP);let s=JSON.parse(e.onlyTrapTerrain);s&&s.length>0&&(s=s.map(Number),$gamePlayer.getGuideAction().setOnlyTerrain(s));let c=JSON.parse(e.exceptTrapTerrain);c&&c.length>0&&(c=c.map(Number),$gamePlayer.getGuideAction().setExceptTerrain(c));let h=JSON.parse(e.onlyTrapRegionID);h&&h.length>0&&(h=h.map(Number),$gamePlayer.getGuideAction().setOnlyRegion(h));let p=JSON.parse(e.exceptTrapRegionID);p&&p.length>0&&(p=p.map(Number),$gamePlayer.getGuideAction().setExceptRegion(p)),"0"!=e.limitAnimation&&this.setLimitAnimation(+e.limitAnimation),TowerDefenseManager.setActive(!0),TowerDefenseManager.updateHUDHealth(),$gameMap.ufcCalcGrid(),$gameSystem.disableMenu(),this.cacheImage(),this._config=!0},TowerDefenseManager.cacheImage=function(){ImageManager.loadSystem("TDSet");for(let e of this._cacheSprite)ImageManager.loadCharacter(e)},TowerDefenseManager.setActive=function(e){this._active=e},TowerDefenseManager.disableTowerDefense=function(e=!1,t=!1,i=!0){this._config=!1,this.setActive(!1),UFC.UFCTD.HUDGUI.ITEMSLOT.destroy(),UFC.UFCTD.HUDGUI.GOLDWINDOW.destroy(),UFC.UFCTD.HUDGUI.HEALTHWINDOW.destroy(),UFC.UFCTD.SHOPGUISETTINGS.enable&&UFC.UFCTD.HUDGUI.SHOP.destroy(),$gameMap.ufcGetGrid().destroy();for(const e of $gameMap.ufcProjectiles())e.destroy(!0);if(e){let e=$gameMap._events.filter(e=>e instanceof Game_TDTower);for(const t of e)t.destroy(!0)}if(t)for(let e=0;e<$gameMap.ufcEnemies().length;e++)$gameMap.ufcEnemies()[e].destroy(!0),e--;i&&($gameParty._towers={}),$gameSystem.enableMenu()},TowerDefenseManager.actionTower=function(e,t){UFC.UFCTD.HUDGUI.TOWERACTION.setTower(e,t)},TowerDefenseManager.selectTower=function(e){this._state=TowerDefenseManager.STATE.BUILD,this._selectedUFCTD=new ufcTowerData(e),this._selectedUFCTD.setPlaceMode(!0),$gamePlayer.getGuideAction().setType(this._selectedUFCTD.getType)},TowerDefenseManager.cancelSelect=function(e=!0){this.gainItem(this._selectedUFCTD._id,1),e&&AudioManager.playSe({name:UFC.UFCTD.CONFIG.sound.towerCancel,volume:100,pitch:100,pan:0}),this.clearSelect(),UFC.UFCTD.HUDGUI.ITEMSLOT.open()},TowerDefenseManager.clearSelect=function(){this._state=TowerDefenseManager.STATE.IDLE,this._selectedUFCTD=null,$gamePlayer.getGuideAction().setActive(!1),$gamePlayer.getGuideActionGraphics().children.length>0&&$gamePlayer.getGuideActionGraphics().removeChildAt(0),$gameMap.ufcGetGrid().setVisible(!1)},TowerDefenseManager.selectTowerMode=function(){const e=new Sprite_ufcTDTower(new Game_TDTower(this.getSelectedTowerData(),$gameMap._mapId));e.setRangeVisibility(!0),$gamePlayer.getGuideAction().setActive(!0),$gamePlayer.getGuideActionGraphics().addChild(e),$gameMap.ufcGetGrid().setType(this.getSelectedTowerData().getType).setVisible(!0),UFC.UFCTD.HUDGUI.ITEMSLOT.close()},TowerDefenseManager.getSelectedTowerData=function(){return this._selectedUFCTD},TowerDefenseManager.addDBEnemy=function(e){if(!$dataTDEnemy[e.id]){$dataTDEnemy[e.id]={};for(let t in e){switch(t){case"itemDrop":e[t]=JSON.parse(e[t]).map(e=>JSON.parse(e))||[];break;case"resistance":e[t]=JSON.parse(e[t])||[]}$dataTDEnemy[e.id][t]=e[t]}}},TowerDefenseManager.addDBTrigger=function(e,t,i,a){$dataTDTrigger[e]||($dataTDTrigger[e]=[]);let o=$gameMap._events[t];$dataTDTrigger[e][o._x]||($dataTDTrigger[e][o._x]=[]),$dataTDTrigger[e][o._x][o._y]||($dataTDTrigger[e][o._x][o._y]={}),$dataTDTrigger[e][o._x][o._y][i]=a},TowerDefenseManager.getTrigger=function(e,t,i){return!!($dataTDTrigger[e]&&$dataTDTrigger[e][t]&&$dataTDTrigger[e][t][i])&&$dataTDTrigger[e][t][i]},TowerDefenseManager.placeTower=function(){let e=$gamePlayer.getGuideAction().getPosition();this._selectedUFCTD._x=e.x,this._selectedUFCTD._y=e.y,this._selectedUFCTD.setPlaceMode(!1),$gameMap.ufcAddTower(this._selectedUFCTD),this._selectedUFCTD.setRangeVisibility(!1),UFC.UFCTD.HUDGUI.ITEMSLOT.open(),this.clearSelect(),AudioManager.playSe({name:UFC.UFCTD.CONFIG.sound.towerPlace,volume:100,pitch:100,pan:0})},TowerDefenseManager.openShop=function(e){this._shopOpen=e},Object.defineProperty(TowerDefenseManager,"getState",{get:function(){return this._state}}),Object.defineProperty(TowerDefenseManager,"getLimitAnimation",{get:function(){return this._limitAnimation}}),Object.defineProperty(TowerDefenseManager,"getHUDGold",{get:function(){return this._HUDGold}}),Object.defineProperty(TowerDefenseManager,"getHUDHealth",{get:function(){return this._HUDHealth}}),Object.defineProperty(TowerDefenseManager,"getGUIItemSlot",{get:function(){return this._GUIItemSlot}}),Object.defineProperty(TowerDefenseManager,"getHUDHealthValue",{get:function(){return $gameVariables.value(UFC.UFCTD.CONFIG.healthVarId)}}),Object.defineProperty(TowerDefenseManager,"getHUDHealthMaxValue",{get:function(){return $gameVariables.value(UFC.UFCTD.CONFIG.healthMaxVarId)}}),Object.defineProperty(TowerDefenseManager,"isActive",{get:function(){return this._active}}),Object.defineProperty(TowerDefenseManager,"isConfigured",{get:function(){return this._config}}),Object.defineProperty(TowerDefenseManager,"isShopOpen",{get:function(){return this._shopOpen&&this.isActive&&UFC.UFCTD.SHOPGUISETTINGS.enable}}),TowerDefenseManager.addTowerList=function(){for(let e=0;e<$dataItems.length;e++)$dataItems[e]&&$dataItems[e].note&&this.addTower(e,$dataItems[e])},TowerDefenseManager.addTower=function(e,t){const i=t.note.split(/[\r\n]+/);let a=!1,o=!1,n="",r=null;for(let e=0;e<i.length&&(i[e].match(/<ufcTD>/)&&(a=!0,r={}),!i[e].match(/<\/ufcTD>/));e++)if(a){if(i[e].match(/<note>/)){o=!0;continue}if(i[e].match(/<\/note>/)){o=!1;continue}if(o){n+=i[e]+"\n";continue}let t=/<(\w*)(:?)([^>]*)>/g.exec(i[e]);t&&(r[t[1]]=t[3])}r&&(r.istowerdata=!0,r.id=e,r.name=t.name,r.iconindex=t.iconIndex,r.bulletanimationid=t.animationId,r.note=n,t.ufcTower=r,-1===this._cacheSprite.indexOf(t.ufcTower.character)&&t.ufcTower.character&&this._cacheSprite.push(t.ufcTower.character),-1===this._cacheSprite.indexOf(t.ufcTower.bulletspritename)&&"?"!=t.ufcTower.bulletspritename&&this._cacheSprite.push(t.ufcTower.bulletspritename))},TowerDefenseManager.convertDirection=function(e){let t=2,i=e.split("/");switch(i.length>1&&(e=PIXI.utils.randomArray(i)),e){case"Left":t=4;break;case"Right":t=6;break;case"Down":t=2;break;case"Up":t=8;break;case"Random":t=PIXI.utils.randomArray([4,6,2,8])}return t};const ufcTowerData=function(){this.initialize(...arguments)};ufcTowerData.prototype.initialize=function(e){switch(this._id=e.id,this._name=e.name,this._attack=+e.attack,this._range=+e.range,this._character=e.character,this._characterIndex=e.characterindex,this._attackSpeed=+e.attackspeed,this._bulletSpeed=+e.bulletspeed||600,this._bulletAnimationId=e.bulletanimationid,this._type=e.type||TowerDefenseManager.TOWERTYPE.TOWER,this._through="true"==e.through,this._health=+e.health||1,this._se={Destroy:e.sedestroy||null,DestroyVolume:e.sedestroyvolume||25},this._type){case TowerDefenseManager.TOWERTYPE.TRAP:this._durability="true"==e.durability,this._durabilityValue=+e.durabilityvalue||1,this._characterIndexX=+e.characterindexx||0,this._attackIndexY=+e.attackindexy||0;break;case TowerDefenseManager.TOWERTYPE.TOWER:this._bulletCharacterName=e.bulletspritename||"?",this._bulletCharacterIndex=e.bulletspriteindex?+e.bulletspriteindex:0,this._bulletCharacterIndexY=e.bulletspriteindexy?+e.bulletspriteindexy:0}this._upgrade=[];let t=Object.keys(e).filter(e=>"upgrade"==e.slice(0,7));if(t.length>0&&t.forEach(t=>{let i=e[t].split("|"),a=0;a=1==i.length?$dataItems[i[0]].price:+i[1],this._upgrade.push({id:+i[0],price:a})}),e.sellprice?this._sellPrice=e.sellprice:this._sellPrice=$dataItems[this._id].price/2,this._effects=[],e.effects){let t=e.effects.split(",");for(const e of t){let t=e.split("|");this._effects.push({name:t[0],effect:+t[1],duration:+t[2],chance:+t[3]||100})}}if(this._auras=[],e.auras){let t=e.auras.split(",");for(const e of t){let t=e.split("|");this._auras.push({name:t[0],effect:+t[1],type:t[2]||"fixed"})}}this._attackType=e.attacktype||TowerDefenseManager.ENEMYTYPE.ALL,this._note=e.note,this._buffs={},this.resetBuffs(),this._x=0,this._y=0,this._event=new PIXI.utils.EventEmitter,this._placeMode=!1},ufcTowerData.prototype.setRangeVisibility=function(e){this._event.emit("setRangeVisibility",e)},ufcTowerData.prototype.getBulletData=function(){return{damage:{damage:this.getAttack(),effects:this._effects},speed:this._bulletSpeed,animationId:this._bulletAnimationId,characterName:this._bulletCharacterName,characterIndex:this._bulletCharacterIndex,characterIndexY:this._bulletCharacterIndexY}},ufcTowerData.prototype.getBuffs=function(e){return e?this._buffs[e]:this._buffs},ufcTowerData.prototype.getBaseValWithAuraType=function(e){switch(e){case TowerDefenseManager.AURATYPE.ATTACK:return this.getBaseAttack;case TowerDefenseManager.AURATYPE.RANGE:return this.getBaseRange;case TowerDefenseManager.AURATYPE.ATTACKSPEED:return this.getBaseAttackSpeed}return!1},ufcTowerData.prototype.resetBuffs=function(){for(const e in TowerDefenseManager.AURATYPE)this._buffs[TowerDefenseManager.AURATYPE[e]]=0},ufcTowerData.prototype.getAttack=function(){return Math.max(0,this.getBaseAttack+this._buffs[TowerDefenseManager.AURATYPE.ATTACK])},ufcTowerData.prototype.getRange=function(){return Math.max(0,this.getBaseRange+this._buffs[TowerDefenseManager.AURATYPE.RANGE])},ufcTowerData.prototype.getAttackSpeed=function(){return this.getBaseAttackSpeed+-1*this._buffs[TowerDefenseManager.AURATYPE.ATTACKSPEED]},ufcTowerData.prototype.setBuffs=function(e){for(const t of e){let e=t.effect;t.type===TowerDefenseManager.AURATYPEMODE.PERCENTAGE&&(e=Math.floor(this.getBaseValWithAuraType(t.name)*(e/100))),0===this._buffs[t.name]?this._buffs[t.name]=e:t.name===TowerDefenseManager.AURATYPE.ATTACKSPEED?this._buffs[t.name]=Math.min(e,this._buffs[t.name]):this._buffs[t.name]=Math.max(e,this._buffs[t.name])}},ufcTowerData.prototype.setPlaceMode=function(e){this._placeMode=e},ufcTowerData.prototype.getAuras=function(){return this._auras},ufcTowerData.prototype.isHaveAura=function(){return this._auras.length>0},ufcTowerData.prototype.isHaveUpgrade=function(){return this._upgrade.length>0},ufcTowerData.prototype.checkGetBuffs=function(){let e=$gameMap._events.filter(e=>e instanceof Game_TDTower&&e.getTowerData()!==this&&e.getTowerData().getType===TowerDefenseManager.TOWERTYPE.TOWER&&e.getTowerData().isHaveAura()&&PIXI.utils.isInRange(this._x,this._y,e._x,e._y,e.getTowerData().getRange()));for(const t of e)this.setBuffs(t.getTowerData().getAuras()),t.addTowerEffectedByAura(this)},Object.defineProperty(ufcTowerData.prototype,"getBaseAttack",{get:function(){return this._attack}}),Object.defineProperty(ufcTowerData.prototype,"getBaseRange",{get:function(){return this._range}}),Object.defineProperty(ufcTowerData.prototype,"getBaseAttackSpeed",{get:function(){return this._attackSpeed}}),Object.defineProperty(ufcTowerData.prototype,"getPlaceMode",{get:function(){return this._placeMode}}),Object.defineProperty(ufcTowerData.prototype,"getType",{get:function(){return this._type}});const ufcTowerEffects=function(){this.initialize(...arguments)};ufcTowerEffects.prototype.initialize=function(e){switch(this._name=e.name,this._effect=e.effect,this._duration=e.duration,this._chance=e.chance,this._lastDamage=e.damage,this._curTime=this._duration,this._isDone=!1,this._effectPerSecond=!1,this._epsTimeDefault=60,this._epsTime=this._epsTimeDefault,this._epsCallback=null,this._name){case TowerDefenseManager.EFFECTS.POISON:this._effectPerSecond=!0}},ufcTowerEffects.prototype.setEPSCallback=function(e){this._epsCallback=e},ufcTowerEffects.prototype.epsCallback=function(){this._epsCallback&&this._epsCallback()},ufcTowerEffects.prototype.getEffect=function(){return this._effect},ufcTowerEffects.prototype.getCriticalDamage=function(){let e=this._lastDamage;return e*=this._effect,e-=this._lastDamage,e=Math.ceil(e)},ufcTowerEffects.prototype.getChanceEffect=function(){let e=Math.randomInt(100);return!(this._chance<100)||this._chance>e},ufcTowerEffects.prototype.isDone=function(){return this._isDone},ufcTowerEffects.prototype.update=function(){this._effectPerSecond&&(this._epsTime--,this._epsTime<=0&&(this._epsTime=this._epsTimeDefault,this.epsCallback())),this._curTime--,this._curTime<=0&&(this._isDone=!0)},ufcTowerEffects.prototype.reset=function(){this._curTime=this._duration,this._isDone=!1};const ufcTowerSpawnData=function(){this.initialize(...arguments)};ufcTowerSpawnData.prototype.initialize=function(e){this._x=e._x,this._y=e._y,this._direction=e.direction};const ufcTowerWaveData=function(){this.initialize(...arguments)};function Window_BaseExtend(){this.initialize(...arguments)}ufcTowerWaveData.prototype.initialize=function(e){this._spawnLocationId=e.spawnLocationId,this._enemy=e.enemy,this._numberSpawn=+e.numberSpawn,this._delayPerSpawn=+e.delayPerSpawn,this._delay=+e.delay,this._start=!1,this._startSE=e.startSE,this._startSEVolume=+e.startSEVolume,this._timeSpawn=0,this._spawnEnemy=!1},ufcTowerWaveData.prototype.getEnemy=function(){return[this._enemy,this._spawnLocationId]},ufcTowerWaveData.prototype.update=function(){this._delay>0?this._delay--:(this._start||(this._start=!0,this._startSE&&AudioManager.playSe({name:this._startSE,volume:this._startSEVolume,pitch:100,pan:0})),this._timeSpawn--,this._timeSpawn<=0&&this.spawnEnemy())},ufcTowerWaveData.prototype.spawnEnemy=function(){this._spawnEnemy=!0,this._timeSpawn=this._delayPerSpawn,this._numberSpawn--},ufcTowerWaveData.prototype.isSpawnEnemy=function(){return!!this._spawnEnemy&&(this._spawnEnemy=!1,!0)},ufcTowerWaveData.prototype.isDone=function(){return this._numberSpawn<=0},Window_BaseExtend.prototype=Object.create(Window_Base.prototype),Window_BaseExtend.prototype.constructor=Window_BaseExtend,Window_BaseExtend.prototype.initialize=function(e){Window_Base.prototype.initialize.call(this,e),this._lineHeight=Window_Base.prototype.lineHeight(),this._defaultLineHeight=this._lineHeight},Window_BaseExtend.prototype.lineHeight=function(){return this._lineHeight},Window_BaseExtend.prototype.setLineHeight=function(e){this._lineHeight=e},Window_BaseExtend.prototype.resetLineHeight=function(){this._lineHeight=this._defaultLineHeight},Window_BaseExtend.prototype.drawTextEx=function(e,t,i,a,o){if("center"==o){let i=this.textSizeEx(e).width;t+=this.itemWidth()/2,t-=i/2,t-=2*this.itemPadding()}this.resetFontSettings();const n=this.createTextState(e,t,i,a);return this.processAllText(n),n.outputWidth},Window_BaseExtend.prototype.clear=function(){this.contents.clear(),this.contentsBack.clear()};const Window_GUIItemSlot=function(){this.initialize(...arguments)};function Window_TDAction(){this.initialize(...arguments)}function Window_TDActionUpgrade(){this.initialize(...arguments)}function Window_TDGold(){this.initialize(...arguments)}function Window_TDHealth(){this.initialize(...arguments)}function Window_TDShop(){this.initialize(...arguments)}function Window_TDStatus(){this.initialize(...arguments)}Window_GUIItemSlot.prototype=Object.create(Window_Command.prototype),Window_GUIItemSlot.prototype.constructor=Window_GUIItemSlot,Window_GUIItemSlot.prototype.initialize=function(){let e=UFC.UFCTD.HUDGUI.SETTINGS.itemSize*this.maxCols()+2*$gameSystem.windowPadding(),t=new Rectangle(Graphics.boxWidth/2-e/2,Graphics.boxHeight,e,this.itemHeight()+2*$gameSystem.windowPadding());t.y-=t.height,Window_Command.prototype.initialize.call(this,t),this._selectKeyboard=!1,this._towers=[],this.setBackgroundType(UFC.UFCTD.HUDGUI.SETTINGS.itemWindowType),UFC.UFCTD.TOOLTIPSETTINGS.enable&&(this.toolTip=new Window_Base(new Rectangle(0,UFC.UFCTD.TOOLTIPSETTINGS.yPosition,UFC.UFCTD.HUDGUI.SETTINGS.itemSize,60)),this.toolTip.setBackgroundType(UFC.UFCTD.TOOLTIPSETTINGS.backgroundType),this.addChild(this.toolTip)),this.refresh()},Window_GUIItemSlot.prototype.moveTooltip=function(e){let t=this._towers[e];if(-1==e||!t)return void(this.toolTip.visible=!1);this.toolTip.visible=!0;let i=UFC.UFCTD.TOOLTIPSETTINGS.fontSize;this.toolTip.contents.fontSize=i;let a=this.toolTip.textWidth(t.name),o=i+2*$gameSystem.windowPadding()+this.toolTip.lineHeight()/2,n=this.itemRect(e);this.toolTip.move(n.x-a/2+UFC.UFCTD.HUDGUI.SETTINGS.itemSize/2-this.colSpacing()/2,this.toolTip.y,a+2*$gameSystem.windowPadding(),o),this.toolTip.createContents(),this.toolTip.setBackgroundType(UFC.UFCTD.TOOLTIPSETTINGS.backgroundType),this.toolTip.contents.fontSize=i,this.toolTip.contents.drawText(t.name,0,0,a,this.toolTip.innerHeight-.15*i,"center")},Window_GUIItemSlot.prototype.select=function(e){this._index!=e&&this.toolTip&&UFC.UFCTD.TOOLTIPSETTINGS.enable&&this.moveTooltip(e),Window_Command.prototype.select.call(this,e)},Window_GUIItemSlot.prototype.callOkHandler=function(){this.activate();let e=this._towers[this.index()];!e||$gameMessage.isBusy()&&!this._selectKeyboard||($gamePlayer.getGuideAction().resetParent(),TowerDefenseManager.gainItem(e.id,-1),TowerDefenseManager.clearSelect(),TowerDefenseManager.selectTower(e),TowerDefenseManager.selectTowerMode(),this._selectKeyboard=!1,$gameMessage.setWindowTower(!1),this.close())},Window_GUIItemSlot.prototype.activeKeyboard=function(){$gameMessage.setWindowTower(!0),this._selectKeyboard=!0,this.activate(),this.select(0)},Window_GUIItemSlot.prototype.deactiveKeyboard=function(){this._selectKeyboard=!1,$gameMessage.setWindowTower(!1),this.deselect(),this.deactivate(),UFC.UFCTD.HUDGUI.SHOP.deselect()},Window_GUIItemSlot.prototype.cursorLeft=function(e){if(e&&0===this.index()&&UFC.UFCTD.SHOPGUISETTINGS.enable)return UFC.UFCTD.HUDGUI.SHOP.selected(),this.deselect(),void this.deactivate();Window_Command.prototype.cursorLeft.call(this,e)},Window_GUIItemSlot.prototype.processCursorMove=function(){!$gameMessage.isBusyDefault()&&this.visible&&(this.isCancelTriggered()&&this._selectKeyboard?this.deactiveKeyboard():(this.isCancelTriggered()&&!this._selectKeyboard&&TowerDefenseManager.getState!=TowerDefenseManager.STATE.BUILD&&this.activeKeyboard(),this._selectKeyboard&&Window_Command.prototype.processCursorMove.call(this)))},Window_GUIItemSlot.prototype.drawAllItems=function(){const e=this.topIndex();for(let t=0;t<this.maxVisibleItems();t++){const i=e+t;i<this.maxItems()&&(this.drawItemBackground(i),this.drawItem(i))}},Window_GUIItemSlot.prototype.drawItemBackground=function(e){const t=this.itemRect(e);if(this.drawBackgroundRect(t),this.commandName(e)){let i=.8,a=t.width*i;this.drawIcon(this.commandIconIndex(e),t.x+(t.width-a)/2,t.y+(t.width-a)/2+this.rowSpacing()/2,a,a)}},Window_GUIItemSlot.prototype.drawItem=function(e){const t=this.itemRect(e);this.resetTextColor(),this.changePaintOpacity(this.isCommandEnabled(e));const i=this.commandNumItem(e);if(i>1){let e=new Rectangle(t.x,t.y,UFC.UFCTD.HUDGUI.SETTINGS.itemNumSize,UFC.UFCTD.HUDGUI.SETTINGS.itemNumSize);e.x+=t.width-e.width,this.drawNumItem(e,i)}},Window_GUIItemSlot.prototype.drawIcon=function(e,t,i,a,o){const n=ImageManager.loadSystem("IconSet"),r=ImageManager.iconWidth,s=ImageManager.iconHeight,c=e%16*r,h=Math.floor(e/16)*s;this.contentsBack.blt(n,c,h,r,s,t,i,a,o)},Window_GUIItemSlot.prototype.drawNumItem=function(e,t){const i="rgba(0, 0, 0, .6)",a=e.x,o=e.y,n=e.width,r=e.height;this.contentsBack.fillRect(a,o,n,r,i),this.contentsBack.strokeRect(a,o,n,r,i),this.contentsBack.fontSize=Math.floor(.9*n),this.contentsBack.drawText(t,a,o,e.width,e.height+this.rowSpacing()/2,"center"),this.resetFontSettings()},Window_GUIItemSlot.prototype.maxCols=function(){return UFC.UFCTD.HUDGUI.SETTINGS.itemCol},Window_Command.prototype.commandNumItem=function(e){return this._list[e].numItem},Window_Command.prototype.commandIconIndex=function(e){return this._list[e].iconIndex},Window_GUIItemSlot.prototype.processTouch=function(){if(Window_Command.prototype.processTouch.call(this),!this.isClosed()&&this.visible)if(this.isTouchedInsideFrame())UFC.UFCTD.HUDGUI.MESSAGE.isHoverHUDItem=!0,this.activate();else{if(this._selectKeyboard)return;UFC.UFCTD.HUDGUI.MESSAGE.isHoverHUDItem=!1,this.deselect(),this.deactivate()}},Window_GUIItemSlot.prototype.onTouchSelect=function(){if(this._doubleTouch=!1,this.isCursorMovable()){const e=this.index(),t=this.hitIndex();t>=0&&(t===this.index()&&(this._doubleTouch=!0),this.select(t)),this.index()!==e&&this.playCursorSound()}},Window_GUIItemSlot.prototype.addCommand=function(e,t,i=1,a=!0,o=null){this._list.push({name:e,iconIndex:t,callback:o,numItem:i,symbol:null,enabled:a,ext:null})},Window_GUIItemSlot.prototype.itemHeight=function(){return UFC.UFCTD.HUDGUI.SETTINGS.itemSize},Window_GUIItemSlot.prototype.itemWidth=function(){return UFC.UFCTD.HUDGUI.SETTINGS.itemSize},Window_GUIItemSlot.prototype.update=function(){Window_Command.prototype.update.call(this),TowerDefenseManager.getGUIItemSlot&&!this._selectKeyboard&&($gameMessage.isBusy()&&this.visible?(this.close(),this.visible=!1):$gameMessage.isBusy()||this.visible||TowerDefenseManager.getState!=TowerDefenseManager.STATE.IDLE||(this.open(),this.visible=!0))},Window_GUIItemSlot.prototype.refresh=function(){Window_Command.prototype.refresh.call(this),this.clearCommandList(),this.deselect(),this.makeCommandTowers(),this.drawAllItems()},Window_GUIItemSlot.prototype.makeCommandTowers=function(){this._towers=$gameParty.towers();let e=this._towers.length<this.maxCols()?this.maxCols():this._towers.length;for(let t=0;t<e;t++)this._towers[t]?this.addCommand(this._towers[t].name,this._towers[t].iconindex,$gameParty.numItems(this._towers[t]),!0):this.addCommand("",0,0,!0)},Window_GUIItemSlot.prototype.close=function(){for(const e of this.children)e.close&&e.close();UFC.UFCTD.HUDGUI.MESSAGE.isHoverHUDItem=!1,UFC.UFCTD.SHOPGUISETTINGS.enable&&UFC.UFCTD.HUDGUI.SHOP.close(),Window_Command.prototype.close.call(this)},Window_GUIItemSlot.prototype.open=function(){for(const e of this.children)e.close&&e.open();UFC.UFCTD.SHOPGUISETTINGS.enable&&UFC.UFCTD.HUDGUI.SHOP.open(),Window_Command.prototype.open.call(this)},Window_TDAction.prototype=Object.create(Window_Command.prototype),Window_TDAction.prototype.constructor=Window_TDAction,Window_TDAction.prototype.initialize=function(e){Window_Command.prototype.initialize.call(this,e),this._lineHeight=Window_Command.prototype.lineHeight(),this._defaultLineHeight=this._lineHeight,this._towerData=null,this._towerDataDestroyCallback=null,this._selected=!1,this.setBackgroundType(0),this.setHandler("cancel",this.onCancel.bind(this));let t=this.x;this.status=new Window_TDStatus(new Rectangle(-t,this.height-240,t,240)),this.addChild(this.status);let i=this.height;this.upgradeWindow=new Window_TDActionUpgrade(new Rectangle(this.width,this.height-i,250,i)),this.addChild(this.upgradeWindow),this.upgradeWindow.on("upgradeTower",this.upgradeTower,this),this.upgradeWindow.on("selectUpgradeWindow",this.selectUpgradeWindow,this),this.hide(),this.close()},Window_TDAction.prototype.colSpacing=function(){return this.rowSpacing()},Window_TDAction.prototype.maxCols=function(){return 2},Window_TDAction.prototype.itemHeight=function(){return this.height/3-2*this.rowSpacing()},Window_TDAction.prototype.selectUpgradeWindow=function(e){e?this.deactivate():this.activate(),this.select(1)},Window_TDAction.prototype.upgradeTower=function(e){AudioManager.playSe({name:UFC.UFCTD.CONFIG.sound.towerUpgrade,volume:80,pitch:100,pan:0}),TowerDefenseManager.gainGold(-+this._towerData._upgrade[e].price),$gamePlayer.getGuideAction().resetParent(),TowerDefenseManager.selectTower($dataItems[this._towerData._upgrade[e].id].ufcTower),TowerDefenseManager.selectTowerMode(),TowerDefenseManager.placeTower(),this._towerDataDestroyCallback(),this.close()},Window_TDAction.prototype.callOkHandler=function(){switch(this.index()){case 0:$gamePlayer.getGuideAction().resetParent(),TowerDefenseManager.clearSelect(),TowerDefenseManager.selectTower($dataItems[this._towerData._id].ufcTower),TowerDefenseManager.selectTowerMode(),this._towerDataDestroyCallback();break;case 1:if(this._towerData.isHaveUpgrade())return this._selected=!0,this.upgradeWindow._selected=!0,this.upgradeWindow.activate(),this.upgradeWindow.refreshStatus(0),this.upgradeWindow.select(0),void this.deactivate();break;case 2:TowerDefenseManager.selectTower($dataItems[this._towerData._id].ufcTower),TowerDefenseManager.cancelSelect(!1),this._towerDataDestroyCallback();break;case 3:AudioManager.playSe({name:UFC.UFCTD.CONFIG.sound.towerSell,volume:80,pitch:100,pan:0}),TowerDefenseManager.gainGold(+this._towerData._sellPrice),this._towerDataDestroyCallback(),UFC.UFCTD.HUDGUI.ITEMSLOT.open();break;case 4:UFC.UFCTD.HUDGUI.ITEMSLOT.open()}this.close()},Window_TDAction.prototype.close=function(){this._towerData&&this._towerData.setRangeVisibility(!1);for(const e of this.children)e.close&&e.close();Window_Command.prototype.close.call(this),$gameMessage.setWindowTower(!1),this.deactivate()},Window_TDAction.prototype.setTower=function(e,t){this._towerData=e,this._towerDataDestroyCallback=t,this.refresh(),this.addCommand("\\FS[20]Move",0,!0);let i=!1,a="\\FS[20]\\C[7]Upgrade";this._towerData.isHaveUpgrade()&&(i=!0,a="\\FS[20]Upgrade"),this.addCommand(a,2,i),this.addCommand("\\FS[20]Pickup",4,!0),this.addCommand("\\FS[16]Sell\n\\FS[20]\\C[14]"+this._towerData._sellPrice+"\\C "+TextManager.currencyUnit,1),this.addCommand("Cancel",3,!0),this.drawAllItems(),this.open(),this.show(),this.activate(),this.select(0),this.status.drawDefaultStatus(this._towerData),this.status.open(),i&&this.upgradeWindow.setUpgrade(this._towerData._upgrade),this._towerData.setRangeVisibility(!0),UFC.UFCTD.HUDGUI.ITEMSLOT.close()},Window_TDAction.prototype.cursorDown=function(e){this.index()===this.maxItems()-this.maxCols()&&e?this.smoothSelect(this.maxItems()-1):Window_Command.prototype.cursorDown.call(this,e)},Window_TDAction.prototype.itemRect=function(e){let t=Window_Command.prototype.itemRect.call(this,e);return e===this.maxItems()-1&&(t.width*=2,t.width+=this.colSpacing()),t},Window_TDAction.prototype.open=function(){SoundManager.playOk(),Window_Command.prototype.open.call(this)},Window_TDAction.prototype.onCancel=function(){UFC.UFCTD.HUDGUI.ITEMSLOT.open(),this.close()},Window_TDAction.prototype.addCommand=function(e,t,i=!0,a=null){this._list.push({name:e,icon:t,callback:a,symbol:null,enabled:i,ext:null})},Window_TDAction.prototype.drawIconTD=function(e,t,i,a){const o=ImageManager.loadSystem("TDSet");if("center"==a)t+=this.itemWidth()/2,t-=24;else if("right"==a){let e=t;t=this.itemWidth(),t-=48,t-=e}const n=e%48*48,r=48*Math.floor(e/48);this.contents.blt(o,n,r,48,48,t,i,48*.8,48*.8)},Window_TDAction.prototype.drawTextEx=function(e,t,i,a,o){if("center"==o){let i=this.textSizeEx(e).width;t+=this.itemWidth()/2,t-=i/2,t-=2*this.itemPadding()}this.resetFontSettings();const n=this.createTextState(e,t,i,a);return this.processAllText(n),n.outputWidth},Window_TDAction.prototype.drawItem=function(e){const t=this.itemLineRect(e);this.resetTextColor(),this.drawIconTD(this._list[e].icon,t.x,t.y);let i=t.y;3==e&&(this.setLineHeight(24),i-=5),this.drawTextEx(this.commandName(e),t.x+48,i,200),3==e&&this.resetLineHeight()},Window_TDAction.prototype.onTouchSelect=function(){if(this._doubleTouch=!1,this.isCursorMovable()){const e=this.index(),t=this.hitIndex();t>=0&&(t===this.index()&&(this._doubleTouch=!0),this.select(t)),this.index()!==e&&this.playCursorSound()}},Window_TDAction.prototype.processTouch=function(){Window_Command.prototype.processTouch.call(this),!this.isTouchedInsideFrame()||this.active||this._selected||this.activate()},Window_TDAction.prototype.refresh=function(){for(const e of this.children)e.contents&&e.contents.clear();Window_Command.prototype.refresh.call(this)},Window_TDAction.prototype.lineHeight=function(){return this._lineHeight},Window_TDAction.prototype.setLineHeight=function(e){this._lineHeight=e},Window_TDAction.prototype.resetLineHeight=function(){this._lineHeight=this._defaultLineHeight},Window_TDAction.prototype.destroy=function(){this.upgradeWindow.removeListener("upgradeTower",this.upgradeTower),this.upgradeWindow.removeListener("selectUpgradeWindow",this.selectUpgradeWindow),Window_Command.prototype.destroy.call(this)},Window_TDActionUpgrade.prototype=Object.create(Window_Command.prototype),Window_TDActionUpgrade.prototype.constructor=Window_TDActionUpgrade,Window_TDActionUpgrade.prototype.initialize=function(e){Window_Command.prototype.initialize.call(this,e),this._tmpIndex=0,this._lineHeight=Window_Command.prototype.lineHeight(),this._selected=!1,this._defaultLineHeight=this._lineHeight,this._upgradeData=[];this._title=new Window_BaseExtend(new Rectangle(0,-60,this.width,60)),this._title.setBackgroundType(2),this.addChild(this._title);this.status=new Window_TDStatus(new Rectangle(this.width,0,360,240)),this.addChild(this.status),this.setHandler("cancel",this.onCancel.bind(this)),this.setBackgroundType(0)},Window_TDActionUpgrade.prototype.onCancel=function(){this._selected=!1,this.windowHovered(!1,!0)},Window_TDActionUpgrade.prototype.maxCols=function(){return 1},Window_TDActionUpgrade.prototype.itemHeight=function(){return this.height/3-2*this.rowSpacing()},Window_TDActionUpgrade.prototype.close=function(){for(const e of this.children)e.close&&e.close();Window_Command.prototype.close.call(this)},Window_TDActionUpgrade.prototype.callOkHandler=function(){let e=this._upgradeData[this.index()];$gameParty.gold()>=e.price?(this.emit("upgradeTower",this.index()),this._selected=!1,this.deactivate()):SoundManager.playBuzzer()},Window_TDActionUpgrade.prototype.setUpgrade=function(e){this.refresh(),this._title.clear(),this._upgradeData=[],this.setLineHeight(28),e.forEach(e=>{let t={data:$dataItems[e.id].ufcTower,price:e.price};this.addCommand("\\FS[20]"+t.data.name+"\n\\C[14]"+t.price+"\\C "+TextManager.currencyUnit,t.data.character,t.data.characterindex,!0),this._upgradeData.push(t)}),this.drawTitle(),this.drawAllItems(),this.open(),this.status.open(),this.deactivate(),this.deselect()},Window_TDActionUpgrade.prototype.drawTitle=function(){const e=ColorManager.itemBackColor1(),t=ColorManager.itemBackColor2();let i=this.contentsWidth()-2,a=this._title.contents.fontSize+10;this._title.contentsBack.gradientFillRect(0,0,i,a,e,t,!0),this._title.drawText("UPGRADE",0,0,i,"center"),this._title.open(),this._title.show()},Window_TDActionUpgrade.prototype.processTouch=function(){Window_Command.prototype.processTouch.call(this),this.isClosed()||(!this.isTouchedInsideFrame()&&!this._selected||this.active?this.isTouchedInsideFrame()||this._selected||!this.active||this.windowHovered(!1):this.windowHovered(!0))},Window_TDActionUpgrade.prototype.windowHovered=function(e,t=!0){e?(this.activate(),this.refreshStatus(this.index()),this._selected=!1):(this.deactivate(),this.deselect()),t&&this.emit("selectUpgradeWindow",e)},Window_TDActionUpgrade.prototype.open=function(){SoundManager.playOk(),Window_Command.prototype.open.call(this)},Window_TDActionUpgrade.prototype.addCommand=function(e,t,i,a=!0,o=null){this._list.push({name:e,character:t,characterIndex:i,callback:o,symbol:null,enabled:a,ext:null})},Window_TDActionUpgrade.prototype.drawCharacter=function(e,t,i,a){let o=ImageManager.loadCharacter(e),n=o.width/12,r=o.height/8,s=(t%4*3+1)*n,c=(4*Math.floor(t/4)+0)*r;this.contents.blt(o,s,c,n,r,i,a,.8*n,.8*r)},Window_TDActionUpgrade.prototype.drawTextEx=function(e,t,i,a,o){if("center"==o){let i=this.textSizeEx(e).width;t+=this.itemWidth()/2,t-=i/2,t-=2*this.itemPadding()}this.resetFontSettings();const n=this.createTextState(e,t,i,a);return this.processAllText(n),n.outputWidth},Window_TDActionUpgrade.prototype.drawItem=function(e){const t=this.itemLineRect(e);this.resetTextColor(),this.drawCharacter(this._list[e].character,this._list[e].characterIndex,t.x,t.y);let i=t.y-10;this.drawTextEx(this.commandName(e),t.x+48,i,200)},Window_TDActionUpgrade.prototype.onTouchSelect=function(){if(this._doubleTouch=!1,this.isCursorMovable()){const e=this.index(),t=this.hitIndex();t>=0&&(t===this.index()&&(this._doubleTouch=!0),this.select(t)),this.index()!==e&&this.playCursorSound()}},Window_TDActionUpgrade.prototype.refreshStatus=function(){this._tmpIndex>=this._upgradeData.length&&(-1==this.index()?this._tmpIndex=0:this._tmpIndex=this.index()),this.status.drawDefaultStatus(new ufcTowerData(this._upgradeData[this._tmpIndex].data))},Window_TDActionUpgrade.prototype.select=function(e){this._tmpIndex!==e&&-1!==e&&this.status&&(this._tmpIndex=e,this.refreshStatus()),Window_Command.prototype.select.call(this,e)},Window_TDActionUpgrade.prototype.refresh=function(){for(const e of this.children)e.contents&&(e.contents.clear(),e.contentsBack.clear());Window_Command.prototype.refresh.call(this)},Window_TDActionUpgrade.prototype.lineHeight=function(){return this._lineHeight},Window_TDActionUpgrade.prototype.setLineHeight=function(e){this._lineHeight=e},Window_TDActionUpgrade.prototype.resetLineHeight=function(){this._lineHeight=this._defaultLineHeight},Window_TDGold.prototype=Object.create(Window_Selectable.prototype),Window_TDGold.prototype.constructor=Window_TDGold,Window_TDGold.prototype.initialize=function(e){Window_Selectable.prototype.initialize.call(this,e),this.refresh()},Window_TDGold.prototype.colSpacing=function(){return 0},Window_TDGold.prototype.refresh=function(){const e=this.itemLineRect(0),t=e.x,i=e.y,a=e.width;this.contents.clear(),this.drawCurrencyValue(this.value(),this.currencyUnit(),t,i,a)},Window_TDGold.prototype.value=function(){return $gameParty.gold()},Window_TDGold.prototype.currencyUnit=function(){return TextManager.currencyUnit},Window_TDGold.prototype.open=function(){this.refresh(),Window_Selectable.prototype.open.call(this)},Window_TDHealth.prototype=Object.create(Window_Selectable.prototype),Window_TDHealth.prototype.constructor=Window_TDHealth,Window_TDHealth.prototype.initialize=function(e){Window_Selectable.prototype.initialize.call(this,e),this.opacity=0,this.refresh()},Window_TDHealth.prototype.colSpacing=function(){return 0},Window_TDHealth.prototype.refresh=function(){const e=this.itemLineRect(0);this.contents.clear(),this.contents.fontSize=22,this.drawBackground(-5,3,200,30),this.drawText(UFC.UFCTD.CONFIG.crystalName,-10,0,200,"center"),this.drawGaugeRect(0,e.height,this.innerWidth,20)},Window_TDHealth.prototype.drawBackground=function(e,t,i,a){const o=ColorManager.dimColor1(),n=ColorManager.dimColor2(),r=i/2;this.contents.gradientFillRect(e,t,r,a,n,o),this.contents.gradientFillRect(e+r,t,r,a,o,n)},Window_TDHealth.prototype.drawGaugeRect=function(e,t,i,a){const o=this.gaugeRate(TowerDefenseManager.getHUDHealthValue,TowerDefenseManager.getHUDHealthMaxValue),n=Math.floor((i-2)*o),r=a-2,s=ColorManager.gaugeBackColor(),c=ColorManager.hpGaugeColor1(),h=ColorManager.hpGaugeColor2();this.contents.fillRect(e,t,i,a,s),this.contents.gradientFillRect(e,t,n,r,c,h)},Window_TDHealth.prototype.gaugeRate=function(e,t){return t>0?e/t:0},Window_TDHealth.prototype.open=function(){this.refresh(),Window_Selectable.prototype.open.call(this)},Window_TDShop.prototype=Object.create(Window_Command.prototype),Window_TDShop.prototype.constructor=Window_TDShop,Window_TDShop.prototype.initialize=function(){let e=new Rectangle(UFC.UFCTD.SHOPGUISETTINGS.iconXPosition,UFC.UFCTD.SHOPGUISETTINGS.iconYPosition+Graphics.boxHeight-UFC.UFCTD.SHOPGUISETTINGS.iconHeight-2*$gameSystem.windowPadding()-this.itemPadding()/2,UFC.UFCTD.SHOPGUISETTINGS.iconWidth+2*$gameSystem.windowPadding()+this.itemPadding(),UFC.UFCTD.SHOPGUISETTINGS.iconHeight+2*$gameSystem.windowPadding()+this.itemPadding());Window_Command.prototype.initialize.call(this,e),this.setBackgroundType(2),this.addCommand("shop","TDShopIcon",!0),this.drawItem(0)},Window_TDShop.prototype.lineHeight=function(){return this.innerHeight-this.itemPadding()-this.rowSpacing()},Window_TDShop.prototype.maxCols=function(){return 1},Window_TDShop.prototype.maxRows=function(){return 1},Window_TDShop.prototype.callOkHandler=function(){let e=UFC.UFCTD.SHOPGUISETTINGS.defaultItems;UFC.UFCTD.SHOPGUISETTINGS.itemsEdit.length>0&&(e=UFC.UFCTD.SHOPGUISETTINGS.itemsEdit),TowerDefenseManager.openShop(!0),SceneManager.push(Scene_Shop),SceneManager.prepareNextScene(e,!0)},Window_TDShop.prototype.processTouch=function(){Window_Command.prototype.processTouch.call(this),this.isClosed()||(!this.isTouchedInsideFrame()&&!this._selected||this.active?this.isTouchedInsideFrame()||this._selected||!this.active||this.windowHovered(!1):this.windowHovered(!0))},Window_TDShop.prototype.windowHovered=function(e){e?(UFC.UFCTD.HUDGUI.MESSAGE.isHoverGUIShop=!0,this.selected(!0)):(UFC.UFCTD.HUDGUI.MESSAGE.isHoverGUIShop=!1,this.deactivate(),this.deselect())},Window_TDShop.prototype.addCommand=function(e,t,i=!0,a=null){this._list.push({name:e,spriteName:t,callback:a,symbol:null,enabled:i,ext:null})},Window_TDShop.prototype.drawItem=function(e){const t=this.itemRect(e);this.drawSprite(this._list[e].spriteName,t.x,t.y)},Window_TDShop.prototype.drawSprite=function(e,t,i){const a=ImageManager.loadSystem(e),o=UFC.UFCTD.SHOPGUISETTINGS.iconWidth,n=UFC.UFCTD.SHOPGUISETTINGS.iconHeight;this.contentsBack.blt(a,0,0,o,n,t,i)},Window_TDShop.prototype.onTouchSelect=function(){if(this._doubleTouch=!1,this.isCursorMovable()){const e=this.index(),t=this.hitIndex();t>=0&&(t===this.index()&&(this._doubleTouch=!0),this.select(t)),this.index()!==e&&this.playCursorSound()}},Window_TDShop.prototype.cursorRight=function(e){if(e&&0===this.index())return this.deselect(),void UFC.UFCTD.HUDGUI.ITEMSLOT.activeKeyboard();Window_Command.prototype.cursorRight.call(this,e)},Window_TDShop.prototype.selected=function(e=!1){this._selected=!0,this.activate(),this.select(0),e&&(this._selected=!1)},Window_TDShop.prototype.deselect=function(){Window_Command.prototype.deselect.call(this),this._selected=!1,this.deactivate()},Window_TDShop.prototype.close=function(e){UFC.UFCTD.HUDGUI.MESSAGE.isHoverGUIShop=!1,Window_Command.prototype.close.call(this,e)},Window_TDStatus.prototype=Object.create(Window_BaseExtend.prototype),Window_TDStatus.prototype.constructor=Window_TDStatus,Window_TDStatus.prototype.initialize=function(e){Window_BaseExtend.prototype.initialize.call(this,e)},Window_TDStatus.prototype.drawDefaultStatus=function(e){this.contents.clear(),this.contentsBack.clear();let t=ImageManager.loadCharacter(e._character),i=e._characterIndex,a=t.width/12,o=t.height/8,n=(i%4*3+1)*a,r=(4*Math.floor(i/4)+0)*o;this.contents.blt(t,n,r,a,o,0,0,1.6*a,1.6*o);let s=1.6*a;this.contents.fontSize=23;const c=ColorManager.itemBackColor1(),h=ColorManager.itemBackColor2();let p=s+1,d=this.contentsWidth()-s-2,l=this.contents.fontSize+10;this.contentsBack.gradientFillRect(p,0,d,l,c,h,!0),this.drawText(e._name,p,0,d,"center");let u=l,T=p,f=["Attack","Range","ASPD","BSPD"],_=[e.getBaseAttack,e.getBaseRange,e.getBaseAttackSpeed,e._bulletSpeed];this.contents.fontSize=14;for(let e=0;e<f.length;e++)this.drawText(f[e],T+e%2*130,u+24*Math.floor(e/2),100);this.changeTextColor(ColorManager.systemColor());for(let e=0;e<_.length;e++)this.drawText(_[e],T+e%2*130,u+24*Math.floor(e/2),80,"right");this.resetTextColor();let g=[],m="+",D=ColorManager.powerUpColor(),y=e.getBuffs(TowerDefenseManager.AURATYPE.ATTACK);e.getAttack()<e.getBaseAttack&&(D=ColorManager.powerDownColor(),m=""),g[0]={value:m+y,color:D},y=e.getBuffs(TowerDefenseManager.AURATYPE.RANGE),e.getRange()<e.getBaseRange&&(D=ColorManager.powerDownColor(),m=""),g[1]={value:m+y,color:D},y=e.getBuffs(TowerDefenseManager.AURATYPE.ATTACKSPEED),e.getAttackSpeed()>e.getBaseAttackSpeed?(D=ColorManager.powerDownColor(),m="+"):m="-",g[2]={value:m+Math.abs(y),color:D};for(let e=0;e<g.length;e++)0!=g[e].value&&(this.resetTextColor(),this.changeTextColor(g[e].color),this.drawText(g[e].value,T+88+e%2*130,u+24*Math.floor(e/2),150));this.resetFontSettings();let w=1.6*o;this.contents.fontSize=18,this.drawText("Note",0,w,100),this.contentsBack.gradientFillRect(0,w+30,this.contentsWidth(),this.contentsHeight()-w,c,h,!0),this.setLineHeight(32);let S=`\\FS[${this.contents.fontSize-3}]\n`;e._note||(S+="\\C[16]None"),this.drawTextEx(S+e._note,5,w+5,this.contentsWidth()),this.resetLineHeight(),this.resetFontSettings()};